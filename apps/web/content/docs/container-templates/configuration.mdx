---
title: Configuration
description: Complete reference for config-manager scripts, files, packages, snapshots, conflict resolution, and service management.
---

## Overview

Config-manager is a git-based declarative configuration management system for LXC containers. It orchestrates four main phases: script execution, file processing, package installation, and snapshot management.

## System Architecture

```
config-manager.service (systemd)
├── Snapshot Creation (pre-sync)
├── Conflict Detection (checksum comparison)
├── Git Sync (clone/pull)
├── Script Execution (00-*.sh → 99-*.sh)
├── File Processing (policy-based deployment)
├── Package Installation (apt, npm, pip, custom)
└── Snapshot Tagging (:good)
```

## Configuration File

### Location: `/etc/config-manager/config.env`

```bash
# Git repository settings
CONFIG_REPO_URL="https://github.com/kethalia/pve-home-lab.git"
CONFIG_BRANCH="main"
CONFIG_PATH="infra/lxc/templates/web3-dev/container-configs"
CONFIG_HELPER_PATH="infra/lxc/scripts/config-manager"

# Snapshot settings
SNAPSHOT_ENABLED="auto"          # auto, yes, no
SNAPSHOT_RETENTION_DAYS="7"      # Days to keep snapshots
SNAPSHOT_BACKEND="auto"          # auto, zfs, lvm, btrfs, none
LVM_SNAPSHOT_SIZE="1G"           # LVM only

# Container user (auto-detected if not set)
CONFIG_CONTAINER_USER="coder"
```

## Script Execution

### Directory: `container-configs/scripts/`

Scripts execute alphabetically on every config sync:

```bash
scripts/
├── 00-pre-checks.sh       # Pre-flight validation
├── 01-setup-user.sh       # User creation
├── 02-docker-install.sh   # Docker installation
├── 50-vscode-server.sh    # Application setup
└── 99-post-setup.sh       # Final verification
```

### Environment Variables

| Variable                   | Description         | Example                      |
| -------------------------- | ------------------- | ---------------------------- |
| `CONFIG_MANAGER_VERSION`   | Version             | `0.4.0`                      |
| `CONFIG_MANAGER_ROOT`      | Repo path           | `/opt/config-manager/repo`   |
| `CONFIG_MANAGER_FIRST_RUN` | First run detection | `true` / `false`             |
| `CONTAINER_OS`             | Detected OS         | `ubuntu`, `debian`, `alpine` |
| `CONTAINER_USER`           | Primary user        | `coder`                      |
| `_PKG_MGR`                 | Package manager     | `apt`, `apk`, `dnf`          |

### Helper Functions

```bash
is_installed <cmd>         # Check if command exists
ensure_installed <pkg>     # Install if not present
log_info <msg>            # Structured logging
log_warn <msg>            # Warning message
log_error <msg>           # Error message
```

### Example Script

```bash
#!/usr/bin/env bash
set -euo pipefail

log_info "=== Installing Docker ==="

# Idempotency check
if is_installed docker; then
    log_info "Docker already installed — skipping"
    exit 0
fi

# Installation
ensure_installed curl
curl -fsSL https://get.docker.com | sh

# Configuration
usermod -aG docker "$CONTAINER_USER"
systemctl enable docker
systemctl start docker

log_info "=== Docker Installation Complete ==="
```

## File Management

### File Triplet Format

For each managed file, create three files:

```
files/
├── bashrc              # Content
├── bashrc.path         # Target: /home/coder
└── bashrc.policy       # Policy: default, replace, or backup
```

### Policies

| Policy    | Target Exists? | Action                           |
| --------- | -------------- | -------------------------------- |
| `replace` | Yes            | Overwrite (always update)        |
| `replace` | No             | Copy                             |
| `default` | Yes            | **Skip** (preserve user changes) |
| `default` | No             | Copy                             |
| `backup`  | Yes            | Backup then copy                 |
| `backup`  | No             | Copy                             |

### Example: Deploy .bashrc

```bash
# files/bashrc
export PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
alias ll='ls -lah'

# files/bashrc.path
/home/coder

# files/bashrc.policy
default
```

**Result**: Deploys to `/home/coder/.bashrc` on first sync, preserves user edits on subsequent syncs.

## Package Management

### Supported Package Managers

| Extension | Manager             | Example                            |
| --------- | ------------------- | ---------------------------------- |
| `.apt`    | APT (Debian/Ubuntu) | `docker.io`                        |
| `.apk`    | APK (Alpine)        | `docker`                           |
| `.dnf`    | DNF (RHEL/Fedora)   | `docker`                           |
| `.npm`    | NPM global          | `typescript@5.0.0`                 |
| `.pip`    | PIP (Python)        | `requests>=2.28`                   |
| `.custom` | Custom installers   | `foundry\|check\|install\|timeout` |

### Package File Format

```bash
# packages/base.apt
curl              # HTTP client
git               # Version control
nodejs=24.*       # Pin to 24.x
docker.io         # Container runtime
```

### Custom Installers

```bash
# packages/cli.custom
# Format: name|check_command|install_command[|timeout]

foundry|command -v forge|curl -L https://foundry.paradigm.xyz | bash && foundryup|600
gh|command -v gh|curl -fsSL https://cli.github.com/packages/... && apt install -y gh|300
starship|command -v starship|curl -fsSL https://starship.rs/install.sh | sh -s -- -y|120
```

## Snapshot System

### Supported Backends

| Backend        | Filesystem | Efficiency       | Features                     |
| -------------- | ---------- | ---------------- | ---------------------------- |
| **ZFS**        | ZFS        | Excellent (CoW)  | Instant snapshots            |
| **LVM**        | LVM2       | Good             | Pre-allocated space required |
| **BTRFS**      | BTRFS      | Excellent (CoW)  | Subvolume snapshots          |
| **File-level** | Any        | Poor (full copy) | Universal fallback           |

### Snapshot Lifecycle

1. **Pre-sync snapshot**: Created before git pull
2. **Configuration sync**: Scripts, files, packages
3. **Tag as `:good`**: Mark successful syncs
4. **Cleanup**: Remove snapshots older than retention period

### Manual Commands

```bash
# List snapshots
config-rollback list

# Show snapshot details
config-rollback show config-manager-20260203-143022

# Restore snapshot (rollback)
config-rollback restore config-manager-20260203-143022

# Check conflict status
config-rollback status

# Mark conflicts as resolved
config-rollback resolve
```

## Conflict Detection

### How It Works

Config-manager compares three sets of checksums:

| Set          | Source               | Purpose          |
| ------------ | -------------------- | ---------------- |
| **Previous** | Last successful sync | Known-good state |
| **Current**  | Before this sync     | Current state    |
| **Git**      | New from repository  | Desired state    |

**Conflict**: File changed locally **AND** in git → Abort sync

### Resolution Options

#### Option A: Manual Resolution

```bash
# Check conflicts
config-rollback status

# Review conflict details
cat /var/lib/config-manager/state/conflicts.log

# Edit files to resolve
vim /home/coder/.bashrc

# Mark as resolved
config-rollback resolve

# Re-sync
systemctl restart config-manager
```

#### Option B: Rollback

```bash
# List snapshots
config-rollback list

# Restore previous good state
config-rollback restore config-manager-20260202-090000

# Re-sync (will succeed now)
systemctl restart config-manager
```

## Service Management

### Systemd Service

```bash
# Check status
systemctl status config-manager

# Manual sync
systemctl restart config-manager

# View logs
journalctl -u config-manager -n 50

# Follow logs
journalctl -u config-manager -f

# Enable/disable
systemctl enable config-manager
systemctl disable config-manager
```

### Exit Codes

| Code | Meaning       | Action                               |
| ---- | ------------- | ------------------------------------ |
| `0`  | Success       | Continue                             |
| `1`  | General error | Check logs                           |
| `2`  | Lock failed   | Another instance running             |
| `3`  | Config error  | Fix `/etc/config-manager/config.env` |
| `4`  | Git error     | Check network, credentials           |
| `5`  | Conflicts     | Resolve or rollback                  |

## File System Layout

```
/usr/local/bin/
├── config-sync.sh         # Main orchestrator
└── config-rollback        # CLI tool

/etc/config-manager/
└── config.env             # Configuration

/var/log/config-manager/
└── sync.log               # Operation log

/var/lib/config-manager/
├── state/                 # Checksums, conflicts
└── backups/               # File-level snapshots

/opt/config-manager/
└── repo/                  # Cloned git repository
```

## Advanced Topics

### Multi-Environment Setup

Use git branches for different environments:

```bash
# Production
CONFIG_BRANCH="main"

# Staging
CONFIG_BRANCH="staging"

# Development
CONFIG_BRANCH="develop"
```

### Custom Repository Structure

```bash
# Non-standard repo layout
CONFIG_PATH="my-custom-path/configs"
```

### Security Considerations

- Don't commit secrets (use environment variables)
- Review scripts (they run as root)
- Use SSH keys for private repos
- Limit snapshot retention based on disk space

## Full Documentation

For the complete configuration reference including detailed examples, all configuration options, and troubleshooting, see:

**[infra/lxc/docs/CONFIGURATION.md](https://github.com/kethalia/pve-home-lab/blob/main/infra/lxc/docs/CONFIGURATION.md)**
