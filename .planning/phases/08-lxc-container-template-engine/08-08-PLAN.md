---
phase: 08-lxc-container-template-engine
plan: 08
type: execute
wave: 3
depends_on:
  ["08-01", "08-02", "08-03", "08-04", "08-05", "08-06", "08-07", "08-09"]
files_modified:
  - templates/engine/README.md
autonomous: false

must_haves:
  truths:
    - "deploy.sh --help shows complete usage information"
    - "deploy.sh --dry-run forge-shield shows resolved config without executing"
    - "All engine lib files source without errors"
    - "All forge-shield scripts pass syntax validation"
    - "minimal template has complete directory structure"
    - "Engine README documents template creation and usage"
  artifacts:
    - path: "templates/engine/README.md"
      provides: "Documentation for the template engine"
      min_lines: 60
  key_links:
    - from: "templates/engine/deploy.sh"
      to: "templates/forge-shield/template.yaml"
      via: "config resolution"
      pattern: "cfg_get"
    - from: "templates/engine/deploy.sh"
      to: "templates/forge-shield/scripts/*.sh"
      via: "script discovery and execution"
      pattern: "scripts.*\\.sh"
---

<objective>
Create engine README documentation and perform integration verification of all components.

Purpose: Validate that all engine libraries, deploy.sh, forge-shield template, and minimal template work together as a cohesive system. Create documentation so users can create new templates.
Output: Engine README + verified integration
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lxc-container-template-engine/08-RESEARCH.md
@.planning/phases/08-lxc-container-template-engine/08-01-SUMMARY.md
@.planning/phases/08-lxc-container-template-engine/08-02-SUMMARY.md
@.planning/phases/08-lxc-container-template-engine/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create engine README and run integration checks</name>
  <files>templates/engine/README.md</files>
  <action>
Create comprehensive README.md for the template engine and run integration validation.

**README.md content:**

1. **Overview** — What the template engine does (config-driven LXC container provisioning)
2. **Prerequisites** — Proxmox VE host, yq (with install command), root access
3. **Quick Start** — `./deploy.sh forge-shield --vmid 200` example
4. **Usage** — All CLI flags with descriptions and examples:
   - `deploy.sh <template-name> [options]`
   - `--vmid N`, `--hostname NAME`, `--cores N`, `--memory N`
   - `--ip ADDR`, `--gateway ADDR`, `--storage NAME`
   - `--dry-run`, `--destroy`, `--resume`, `--verbose`, `--help`
5. **Template Structure** — Directory convention:
   ```
   my-template/
   ├── template.yaml          # Required: declarative config
   ├── scripts/               # Numbered provisioning scripts
   │   ├── 00_base.sh
   │   └── 99_verify.sh
   ├── files/                 # Files pushed into container
   │   └── home/USER/...     # USER replaced with actual username
   └── hooks/                 # Lifecycle hooks
       ├── pre-deploy.sh
       └── post-deploy.sh
   ```
6. **Creating a New Template** — Step-by-step:
   - Copy `minimal/` as starting point
   - Edit `template.yaml` with desired config
   - Add numbered scripts to `scripts/`
   - Add files to push in `files/`
   - Add hooks if needed
   - Deploy: `./engine/deploy.sh my-template`
7. **template.yaml Reference** — All supported fields with types and defaults
8. **Script Conventions:**
   - Numbered prefix: `00_` through `99_` for execution order
   - Must be idempotent (guard checks at top)
   - Receive env vars: USERNAME, USER_SHELL, CTID
   - Use `set -euo pipefail`
   - Run as root, use `su - $USERNAME -c` for user-level operations
9. **Engine Architecture** — Brief description of lib/ modules
10. **Resume/Recovery** — How `.deploy-state` works, `--resume` flag
11. **Available Templates** — List forge-shield and minimal with descriptions

**Integration validation (run as part of this task):**

- `bash -n templates/engine/deploy.sh` — syntax check
- `bash -n templates/engine/lib/*.sh` — all libs syntax check
- `bash -n templates/forge-shield/scripts/*.sh` — all scripts syntax check
- `bash -n templates/forge-shield/hooks/*.sh` — hooks syntax check
- `bash -n templates/minimal/scripts/*.sh` — minimal scripts syntax check
- Verify deploy.sh sources all lib files correctly (grep for source statements)
- Verify template.yaml is valid YAML (use python3 or yq if available)
- Verify all files referenced in template.yaml exist
- Count total scripts, files, check directory structure completeness

Report any issues found and fix them.
</action>
<verify>
All bash -n syntax checks pass. README.md exists and is comprehensive (60+ lines). `./templates/engine/deploy.sh --help` prints usage information.
</verify>
<done>Engine README created with full documentation. All files pass syntax validation. Directory structure is complete and consistent.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete LXC container template engine with:
- Engine: deploy.sh + 6 library modules in engine/lib/
- forge-shield template: template.yaml + 13 provisioning scripts + 6 pushable files + 2 hooks
- minimal template: template.yaml + 2 scripts
- Engine README with full documentation

Directory structure:

```
templates/
├── engine/
│   ├── deploy.sh
│   ├── lib/ (6 modules)
│   └── README.md
├── forge-shield/
│   ├── template.yaml
│   ├── scripts/ (13 scripts)
│   ├── files/ (6 files with USER placeholder, including .tmux.conf)
│   └── hooks/ (2 hooks)
└── minimal/
    ├── template.yaml
    ├── scripts/ (2 scripts)
    └── files/ (.gitkeep)
```

  </what-built>
  <how-to-verify>
1. Review the directory structure: `find templates/ -type f | sort`
2. Review deploy.sh --help output: `./templates/engine/deploy.sh --help`
3. Spot-check a few scripts for quality (idempotency, error handling)
4. Review template.yaml for completeness
5. Optionally test dry-run on Proxmox host: `./templates/engine/deploy.sh forge-shield --dry-run`
6. If satisfied, the next step is to test a real deployment on a Proxmox host
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All bash files pass syntax validation
- deploy.sh --help works
- Directory structure matches the user's specified layout
- README documents template creation workflow
- forge-shield template.yaml contains all user-specified packages, tools, and config
</verification>

<success_criteria>

- Engine is complete and documented
- forge-shield template has all 13+ scripts, 5 files, 2 hooks
- minimal template demonstrates extensibility
- User has reviewed and approved the output
- System is ready for real deployment testing on Proxmox host
  </success_criteria>

<output>
After completion, create `.planning/phases/08-lxc-container-template-engine/08-08-SUMMARY.md`
</output>
