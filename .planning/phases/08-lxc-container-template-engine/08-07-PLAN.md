---
phase: 08-lxc-container-template-engine
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/forge-shield/files/home/USER/.claude/commands/security-gate.md
  - templates/forge-shield/files/home/USER/.claude/commands/audit-solidity.md
  - templates/forge-shield/files/home/USER/.local/bin/security-gate.sh
  - templates/forge-shield/files/home/USER/.local/bin/zap-scan.sh
  - templates/forge-shield/files/home/USER/CLAUDE.md
  - templates/forge-shield/files/home/USER/.tmux.conf
  - templates/forge-shield/hooks/pre-deploy.sh
  - templates/forge-shield/hooks/post-deploy.sh
  - templates/minimal/template.yaml
  - templates/minimal/scripts/00_base.sh
  - templates/minimal/scripts/99_verify.sh
autonomous: true

must_haves:
  truths:
    - "/security-gate and /audit-solidity Claude slash commands are ready to use"
    - "security-gate.sh and zap-scan.sh are in user's PATH (~/.local/bin)"
    - "CLAUDE.md documents the full environment for Claude Code context"
    - "Pre-deploy hook validates Proxmox host prerequisites (runs on host, not in container)"
    - "Post-deploy hook prints connection instructions"
    - "minimal/ template demonstrates creating new templates by directory convention"
  artifacts:
    - path: "templates/forge-shield/files/home/USER/.claude/commands/security-gate.md"
      provides: "Claude /security-gate slash command"
      min_lines: 15
    - path: "templates/forge-shield/files/home/USER/.claude/commands/audit-solidity.md"
      provides: "Claude /audit-solidity slash command"
      min_lines: 15
    - path: "templates/forge-shield/files/home/USER/.local/bin/security-gate.sh"
      provides: "Security gate CLI script"
      min_lines: 30
    - path: "templates/forge-shield/files/home/USER/.local/bin/zap-scan.sh"
      provides: "ZAP scan wrapper script"
      min_lines: 20
    - path: "templates/forge-shield/files/home/USER/CLAUDE.md"
      provides: "Environment documentation for Claude Code"
      min_lines: 40
    - path: "templates/forge-shield/hooks/pre-deploy.sh"
      provides: "Pre-deployment validation hook"
      min_lines: 10
    - path: "templates/forge-shield/hooks/post-deploy.sh"
      provides: "Post-deployment summary hook"
      min_lines: 10
    - path: "templates/minimal/template.yaml"
      provides: "Minimal template example config"
      min_lines: 20
  key_links:
    - from: "templates/forge-shield/files/home/USER/.claude/commands/security-gate.md"
      to: "templates/forge-shield/files/home/USER/.local/bin/security-gate.sh"
      via: "Slash command references the script"
      pattern: "security-gate\\.sh"
    - from: "templates/minimal/template.yaml"
      to: "templates/engine/deploy.sh"
      via: "Minimal template deployable by same engine"
      pattern: "name:|container:|scripts_dir:"
---

<objective>
Create all template files (Claude commands, utility scripts, CLAUDE.md), lifecycle hooks, and the minimal example template.

Purpose: The files/ directory contains artifacts that get pushed into the container with USER placeholder replacement. Hooks run at lifecycle boundaries. The minimal/ template proves the engine is truly reusable — anyone can create a new template by copying this directory.
Output: forge-shield files/ and hooks/, minimal/ template
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lxc-container-template-engine/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forge-shield files/ directory (Claude commands, scripts, CLAUDE.md, tmux.conf)</name>
  <files>
    templates/forge-shield/files/home/USER/.claude/commands/security-gate.md
    templates/forge-shield/files/home/USER/.claude/commands/audit-solidity.md
    templates/forge-shield/files/home/USER/.local/bin/security-gate.sh
    templates/forge-shield/files/home/USER/.local/bin/zap-scan.sh
    templates/forge-shield/files/home/USER/CLAUDE.md
    templates/forge-shield/files/home/USER/.tmux.conf
  </files>
  <action>
Create all files that will be pushed into the container via the engine's file push mechanism. `USER` in paths gets replaced with the actual username.

**security-gate.md** — Claude slash command for `/security-gate`:
Content should be a Claude Code custom command that runs a comprehensive security gate on the current project. It should:

- Instruct Claude to run the security-gate.sh script
- Parse the output and provide a summary
- Flag any critical findings
- Format: markdown instruction file that Claude Code reads as a slash command

Example content:

```markdown
Run a comprehensive security gate check on the current project.

Execute `~/.local/bin/security-gate.sh` in the project root and analyze the results.

Steps:

1. Run security-gate.sh and capture output
2. Parse findings from each tool (Semgrep, Trivy, Gitleaks, Slither if Solidity project)
3. Categorize findings by severity (Critical, High, Medium, Low)
4. Provide actionable remediation for Critical and High findings
5. Summarize overall security posture

If this is a Solidity/Foundry project, also run `/audit-solidity` for deeper analysis.
```

**audit-solidity.md** — Claude slash command for `/audit-solidity`:
Content for Solidity-specific security audit:

```markdown
Perform a comprehensive Solidity smart contract security audit.

Steps:

1. Run `slither .` in the project root — analyze all findings
2. Run `aderyn .` for additional static analysis
3. If available, run `solhint 'contracts/**/*.sol'` for style/best practices
4. Check for common vulnerability patterns:
   - Reentrancy
   - Integer overflow/underflow (pre-0.8.0)
   - Access control issues
   - Unchecked external calls
   - Front-running vulnerabilities
   - Storage collision in proxies
5. Provide findings organized by severity
6. Suggest specific code fixes for each finding
7. Rate overall contract security (Critical/High/Medium/Low risk)
```

**security-gate.sh** — Executable security gate script (make executable):

```bash
#!/usr/bin/env bash
set -euo pipefail
# security-gate.sh — Run all security tools against the current project

PROJECT_DIR="${1:-.}"
REPORT_DIR="${PROJECT_DIR}/.security-reports"
mkdir -p "$REPORT_DIR"

echo "=== Security Gate — $(date) ==="
echo "Project: $PROJECT_DIR"
echo ""

PASSED=0
FAILED=0
WARNINGS=0

# Gitleaks — secret detection
echo "--- Gitleaks (Secret Detection) ---"
if gitleaks detect --source "$PROJECT_DIR" --report-path "$REPORT_DIR/gitleaks.json" --report-format json 2>/dev/null; then
    echo "  ✓ No secrets detected"
    ((PASSED++))
else
    echo "  ✗ Secrets detected! See $REPORT_DIR/gitleaks.json"
    ((FAILED++))
fi

# Semgrep — static analysis
echo "--- Semgrep (Static Analysis) ---"
if semgrep scan --config auto "$PROJECT_DIR" --json -o "$REPORT_DIR/semgrep.json" 2>/dev/null; then
    echo "  ✓ Semgrep scan complete. See $REPORT_DIR/semgrep.json"
    ((PASSED++))
else
    echo "  ! Semgrep found issues. See $REPORT_DIR/semgrep.json"
    ((WARNINGS++))
fi

# Trivy — filesystem vulnerability scan
echo "--- Trivy (Vulnerability Scan) ---"
if trivy fs "$PROJECT_DIR" --format json -o "$REPORT_DIR/trivy.json" 2>/dev/null; then
    echo "  ✓ Trivy scan complete. See $REPORT_DIR/trivy.json"
    ((PASSED++))
else
    echo "  ! Trivy found vulnerabilities. See $REPORT_DIR/trivy.json"
    ((WARNINGS++))
fi

# Slither — Solidity analysis (only if foundry.toml or hardhat.config exists)
if [[ -f "$PROJECT_DIR/foundry.toml" ]] || [[ -f "$PROJECT_DIR/hardhat.config.js" ]] || [[ -f "$PROJECT_DIR/hardhat.config.ts" ]]; then
    echo "--- Slither (Solidity Analysis) ---"
    if slither "$PROJECT_DIR" --json "$REPORT_DIR/slither.json" 2>/dev/null; then
        echo "  ✓ Slither scan complete. See $REPORT_DIR/slither.json"
        ((PASSED++))
    else
        echo "  ! Slither found issues. See $REPORT_DIR/slither.json"
        ((WARNINGS++))
    fi
fi

echo ""
echo "=== Security Gate Summary ==="
echo "  Passed:   $PASSED"
echo "  Warnings: $WARNINGS"
echo "  Failed:   $FAILED"
echo "  Reports:  $REPORT_DIR/"

if [[ $FAILED -gt 0 ]]; then
    echo ""
    echo "❌ SECURITY GATE FAILED — Fix critical issues before proceeding"
    exit 1
else
    echo ""
    echo "✅ SECURITY GATE PASSED"
    exit 0
fi
```

**zap-scan.sh** — Executable ZAP scan wrapper (make executable):

```bash
#!/usr/bin/env bash
set -euo pipefail
# zap-scan.sh — Run OWASP ZAP baseline scan against a target URL

TARGET_URL="${1:-}"
if [[ -z "$TARGET_URL" ]]; then
    echo "Usage: zap-scan.sh <target-url>"
    echo "Example: zap-scan.sh http://localhost:3000"
    exit 1
fi

REPORT_DIR="${2:-.security-reports}"
mkdir -p "$REPORT_DIR"

echo "=== ZAP Baseline Scan ==="
echo "Target: $TARGET_URL"
echo ""

# Run ZAP in headless/command-line mode
if command -v zap &>/dev/null; then
    zap -cmd -quickurl "$TARGET_URL" \
        -quickout "$REPORT_DIR/zap-report.html" \
        -quickprogress 2>&1 || true

    echo ""
    echo "Report saved to: $REPORT_DIR/zap-report.html"
else
    echo "ERROR: ZAP not found. Install with: apt install zaproxy"
    exit 1
fi
```

**CLAUDE.md** — Environment documentation for Claude Code:
Create a comprehensive CLAUDE.md that tells Claude Code what tools are available in this environment. Include:

- Environment name: forge-shield
- Available languages and versions (Node 22, Python 3.12, Go 1.23, Rust stable)
- EVM tools (Foundry suite, solc-select, Solhint)
- Security tools with descriptions (Semgrep, Trivy, Gitleaks, Slither, Aderyn, Echidna, Mythril, ZAP)
- Custom scripts: security-gate.sh, zap-scan.sh (with usage)
- Claude slash commands: /security-gate, /audit-solidity
- Key paths: ~/.foundry/bin, ~/.cargo/bin, ~/.local/bin, ~/go/bin
- Project conventions: Use Foundry for Solidity, pnpm for Node
- Security workflow: Run /security-gate before committing, /audit-solidity for smart contracts

**.tmux.conf** — Basic tmux configuration:
Create a sensible tmux config with:

- Set prefix to Ctrl-a (more ergonomic than default Ctrl-b)
- Enable mouse support: `set -g mouse on`
- Set base index to 1 (windows and panes): `set -g base-index 1` and `setw -g pane-base-index 1`
- Set 256 color support: `set -g default-terminal "screen-256color"`
- Increase scrollback buffer: `set -g history-limit 10000`
- Faster key repetition: `set -sg escape-time 0`
- Split panes with | and - : `bind | split-window -h` and `bind - split-window -v`
- Reload config shortcut: `bind r source-file ~/.tmux.conf \; display "Reloaded"`
- Status bar with useful info (hostname, time)
  </action>
  <verify>
  Verify all files exist: `ls templates/forge-shield/files/home/USER/.claude/commands/security-gate.md templates/forge-shield/files/home/USER/.claude/commands/audit-solidity.md templates/forge-shield/files/home/USER/.local/bin/security-gate.sh templates/forge-shield/files/home/USER/.local/bin/zap-scan.sh templates/forge-shield/files/home/USER/CLAUDE.md templates/forge-shield/files/home/USER/.tmux.conf`. Verify shell scripts pass syntax check: `bash -n templates/forge-shield/files/home/USER/.local/bin/security-gate.sh && bash -n templates/forge-shield/files/home/USER/.local/bin/zap-scan.sh`.
  </verify>
  <done>6 files created in files/ directory. Claude slash commands document security workflows. security-gate.sh runs all tools with reporting. zap-scan.sh wraps ZAP. CLAUDE.md documents the full environment. .tmux.conf provides sensible tmux defaults.</done>
  </task>

<task type="auto">
  <name>Task 2: Create hooks and minimal template</name>
  <files>
    templates/forge-shield/hooks/pre-deploy.sh
    templates/forge-shield/hooks/post-deploy.sh
    templates/minimal/template.yaml
    templates/minimal/scripts/00_base.sh
    templates/minimal/scripts/99_verify.sh
  </files>
  <action>
Create forge-shield lifecycle hooks and the minimal example template.

**pre-deploy.sh** — Pre-deployment validation (runs ON THE PROXMOX HOST, before container creation):

- Make executable
- This hook runs on the HOST, not inside a container. The container doesn't exist yet.
- Check that the OS template file exists: verify the ostemplate path is valid (e.g., `ls /var/lib/vz/template/cache/ubuntu-24.04-*.tar.zst`)
- Check that the storage target exists: `pvesm status | grep -q "$STORAGE"` (uses STORAGE env var)
- Check that the VMID is not already in use: `! pct status "$CTID" &>/dev/null || { echo "[pre-deploy] ERROR: VMID $CTID already exists"; exit 1; }`
- Check available disk space on host for the storage: `df -h /var/lib/vz/ | tail -1` (log it)
- Echo "Pre-deploy host checks passed" on success
- Log with `[pre-deploy]` prefix

**post-deploy.sh** — Post-deployment summary (runs INSIDE container after everything):

- Make executable
- Print a nice summary box:
  ```
  ╔══════════════════════════════════════════════════╗
  ║        forge-shield — Deployment Complete        ║
  ╠══════════════════════════════════════════════════╣
  ║  Connect: pct enter <CTID>                       ║
  ║  User:    <USERNAME>                              ║
  ║                                                   ║
  ║  Quick Start:                                     ║
  ║  1. su - <USERNAME>                               ║
  ║  2. claude (authenticate Claude Code)             ║
  ║  3. mkdir project && cd project && forge init     ║
  ║  4. claude /security-gate                         ║
  ║                                                   ║
  ║  Available Commands:                              ║
  ║  • /security-gate — Run all security tools        ║
  ║  • /audit-solidity — Solidity-specific audit      ║
  ║  • security-gate.sh <dir> — CLI security scan     ║
  ║  • zap-scan.sh <url> — Web app security scan      ║
  ╚══════════════════════════════════════════════════╝
  ```
- Use `$CTID` and `$USERNAME` env vars in the output
- Log with `[post-deploy]` prefix

**minimal/template.yaml** — Minimal example template:

```yaml
name: minimal
description: "Minimal LXC container template — use as a starting point for new templates"
version: "1.0.0"

container:
  ostemplate: "local:vztmpl/ubuntu-24.04-standard_24.04-2_amd64.tar.zst"
  hostname: "minimal"
  cores: 1
  memory: 1024
  swap: 512
  disk: 8
  storage: "local-lvm"
  network:
    bridge: "vmbr0"
    ip: "dhcp"
  unprivileged: true
  features:
    - nesting=1
  tags:
    - minimal

user:
  name: coder
  uid: 1000
  shell: /bin/bash
  sudo: true

packages:
  apt:
    - curl
    - wget
    - git
    - vim
    - sudo
    - ca-certificates

scripts_dir: scripts/
files_dir: files/

env:
  LANG: "en_US.UTF-8"
```

**minimal/scripts/00_base.sh** — Minimal base setup:

- Executable, idempotent
- Configure locale
- Run apt-get update
- Simple and short — demonstrates the convention
- Log with `[00_base]` prefix

**minimal/scripts/99_verify.sh** — Minimal verification:

- Check: curl, git, vim available
- Print simple summary
- Log with `[99_verify]` prefix

Create empty `templates/minimal/files/` directory with a `.gitkeep` file to preserve the convention.
</action>
<verify>
`bash -n templates/forge-shield/hooks/pre-deploy.sh && bash -n templates/forge-shield/hooks/post-deploy.sh && bash -n templates/minimal/scripts/00_base.sh && bash -n templates/minimal/scripts/99_verify.sh` — all pass syntax check. Verify minimal template YAML is valid.
</verify>
<done>forge-shield hooks validate environment (pre-deploy) and print usage guide (post-deploy). minimal/ template provides a complete, simple example for creating new templates.</done>
</task>

</tasks>

<verification>
- All files in forge-shield/files/ exist with correct paths (USER placeholder in paths)
- Shell scripts pass bash -n
- Claude commands are markdown files with clear instructions
- CLAUDE.md is comprehensive (40+ lines)
- Hooks are executable
- minimal/ template has template.yaml + scripts/ + files/ (complete structure)
</verification>

<success_criteria>

- /security-gate and /audit-solidity Claude slash commands created
- security-gate.sh runs Gitleaks, Semgrep, Trivy, Slither (if applicable) with JSON reports
- zap-scan.sh wraps ZAP command-line scan
- CLAUDE.md documents all tools, paths, and workflows
- pre-deploy.sh validates network and resources
- post-deploy.sh prints connection guide and quick start
- minimal/ template is deployable by the engine (same structure conventions)
  </success_criteria>

<output>
After completion, create `.planning/phases/08-lxc-container-template-engine/08-07-SUMMARY.md`
</output>
