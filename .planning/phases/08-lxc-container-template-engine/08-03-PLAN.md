---
phase: 08-lxc-container-template-engine
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/forge-shield/template.yaml
  - templates/forge-shield/scripts/00_base-system.sh
  - templates/forge-shield/scripts/01_create-user.sh
autonomous: true

must_haves:
  truths:
    - "template.yaml declares all container resources, packages, user config, and env vars"
    - "00_base-system.sh configures locale, timezone, and base system settings"
    - "01_create-user.sh creates the non-root user with sudo, correct shell, and home dir"
  artifacts:
    - path: "templates/forge-shield/template.yaml"
      provides: "Complete declarative config for forge-shield template"
      min_lines: 80
      contains: "name: forge-shield"
    - path: "templates/forge-shield/scripts/00_base-system.sh"
      provides: "Base system configuration (locale, timezone, apt update)"
      min_lines: 15
    - path: "templates/forge-shield/scripts/01_create-user.sh"
      provides: "Non-root user creation with sudo and shell config"
      min_lines: 20
  key_links:
    - from: "templates/forge-shield/template.yaml"
      to: "templates/engine/lib/config.sh"
      via: "yq parsing by cfg_get functions"
      pattern: "container:|packages:|user:|env:"
---

<objective>
Create the forge-shield template.yaml declarative config and the two foundational provisioning scripts (base system setup and user creation).

Purpose: template.yaml is the single source of truth for the forge-shield template. The base scripts establish the container's foundation — locale, timezone, system updates, and the non-root user account — before any tool installations.
Output: template.yaml + 2 provisioning scripts
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lxc-container-template-engine/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forge-shield template.yaml</name>
  <files>templates/forge-shield/template.yaml</files>
  <action>
Create `templates/forge-shield/template.yaml` matching the user's spec exactly. This is the declarative configuration that the engine reads.

Use the exact structure from the user's phase prompt. Key sections:

```yaml
name: forge-shield
description: "Full-stack + EVM dev environment with GSD and security tooling"
version: "1.0.0"

container:
  ostemplate: "local:vztmpl/ubuntu-24.04-standard_24.04-2_amd64.tar.zst"
  hostname: "forge-shield"
  cores: 4
  memory: 8192
  swap: 4096
  disk: 50
  storage: "local-lvm"
  network:
    bridge: "vmbr0"
    ip: "dhcp"
    gateway: ""
  dns:
    nameserver: ""
    searchdomain: ""
  unprivileged: true
  features:
    - nesting=1
    - keyctl=1
  start_on_create: true
  tags:
    - dev
    - security

user:
  name: coder
  uid: 1000
  shell: /bin/zsh
  sudo: true
  ssh_keys: []

packages:
  apt:
    - build-essential
    - curl
    - wget
    - git
    - unzip
    - zip
    - jq
    - sudo
    - ca-certificates
    - gnupg
    - software-properties-common
    - apt-transport-https
    - lsb-release
    - python3
    - python3-pip
    - python3-venv
    - python3-dev
    - nmap
    - nikto
    - net-tools
    - dnsutils
    - iputils-ping
    - vim
    - nano
    - zsh
    - tmux
    - fzf
    - ripgrep
    - fd-find
    - bat
    - openssh-client
    - locales
    - default-jre
    - pipx
  npm:
    - pnpm@latest

scripts_dir: scripts/
files_dir: files/

hooks:
  pre_deploy: hooks/pre-deploy.sh
  post_deploy: hooks/post-deploy.sh

env:
  LANG: "en_US.UTF-8"
  LC_ALL: "en_US.UTF-8"
  NPM_CONFIG_PREFIX: "/home/USER/.npm-global"
  PATH_APPEND:
    - "/home/USER/.npm-global/bin"
    - "/home/USER/.local/bin"
    - "/home/USER/.cargo/bin"
    - "/home/USER/.foundry/bin"
    - "/home/USER/go/bin"
    - "/usr/local/go/bin"
```

Notes:

- Add `pipx` to the apt packages list (research says it's needed for PEP 668 on Ubuntu 24.04)
- Remove `"@anthropic-ai/claude-code"` from npm packages — Claude Code is installed via curl script in its own provisioning script (30_claude-code.sh), not via npm
- DO NOT include pip, cargo, or go packages in template.yaml — these tools have dedicated install scripts that handle installation with proper guards, fallbacks, and user-level setup:
  - semgrep, slither-analyzer, mythril, solc-select → installed via pipx in scripts 40_security-web.sh, 41_security-solidity.sh, 21_solc-select.sh
  - solhint → installed via npm in 41_security-solidity.sh
  - aderyn → uses curl installer (NOT cargo install) in 41_security-solidity.sh
  - opencode → installed via curl/go in 31_opencode.sh
- Keep only `pnpm@latest` in npm packages (generic tooling, no dedicated script)
- Comments in YAML to explain non-obvious choices
  </action>
  <verify>
  If yq is available: `yq '.name' templates/forge-shield/template.yaml` returns "forge-shield". Otherwise verify YAML is valid with `python3 -c "import yaml; yaml.safe_load(open('templates/forge-shield/template.yaml'))"` or just check the file exists and is non-empty.
  </verify>
  <done>template.yaml contains complete forge-shield config with apt packages + pnpm (no pip/cargo/go — handled by scripts), container settings, user config, env vars, and hook references.</done>
  </task>

<task type="auto">
  <name>Task 2: Create base system and user creation scripts</name>
  <files>
    templates/forge-shield/scripts/00_base-system.sh
    templates/forge-shield/scripts/01_create-user.sh
  </files>
  <action>
Create two foundational provisioning scripts. Both must be executable (`chmod +x`), start with `#!/usr/bin/env bash`, use `set -euo pipefail`, and be idempotent.

These scripts run INSIDE the container via `pct exec`. They receive environment variables: `USERNAME`, `USER_SHELL`, `CTID`, and any from the template's `env:` block.

**00_base-system.sh** — Base system configuration:

- Guard: skip if `/etc/locale.gen` already has `en_US.UTF-8` uncommented (idempotent check)
- Configure locale: uncomment `en_US.UTF-8 UTF-8` in `/etc/locale.gen`, run `locale-gen`, set `update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8`
- Set timezone to UTC: `ln -sf /usr/share/zoneinfo/UTC /etc/localtime && dpkg-reconfigure -f noninteractive tzdata`
- Run `apt-get update` (always, to ensure fresh package lists)
- Install apt-transport-https and ca-certificates (ensures HTTPS repos work for later scripts)
- Clean apt cache: `apt-get clean && rm -rf /var/lib/apt/lists/*` (will be refreshed when needed)
- Log progress with echo statements prefixed with `[00_base-system]`

**01_create-user.sh** — Create non-root user:

- Guard: skip if user already exists (`id "$USERNAME" &>/dev/null`)
- Create user with home directory: `useradd -m -s "$USER_SHELL" -u "${USER_UID:-1000}" "$USERNAME"`
- Add to sudo group: `usermod -aG sudo "$USERNAME"`
- Configure passwordless sudo: write `$USERNAME ALL=(ALL) NOPASSWD:ALL` to `/etc/sudoers.d/$USERNAME` with mode 0440
- Validate sudoers file: `visudo -cf /etc/sudoers.d/$USERNAME`
- Create essential directories:
  - `/home/$USERNAME/.local/bin`
  - `/home/$USERNAME/.config`
  - `/home/$USERNAME/.ssh` (mode 0700)
- Set ownership: `chown -R $USERNAME:$USERNAME /home/$USERNAME`
- If SSH keys are provided (via `SSH_KEYS` env var), write to `.ssh/authorized_keys` with mode 0600
- Log progress with echo statements prefixed with `[01_create-user]`
  </action>
  <verify>
  `bash -n templates/forge-shield/scripts/00_base-system.sh && bash -n templates/forge-shield/scripts/01_create-user.sh` — both pass syntax check.
  </verify>
  <done>00_base-system.sh configures locale/timezone and 01_create-user.sh creates non-root user with sudo. Both are idempotent and executable.</done>
  </task>

</tasks>

<verification>
- template.yaml is valid YAML with all required sections
- Both scripts pass bash -n syntax check
- Both scripts are executable
- Scripts use idempotent guard checks
- Scripts use environment variables (USERNAME, USER_SHELL) not hardcoded values
</verification>

<success_criteria>

- template.yaml contains all sections: name, container, user, packages, scripts_dir, files_dir, hooks, env
- 00_base-system.sh handles locale, timezone, base apt setup
- 01_create-user.sh creates user with sudo, home dir, essential directories
- All files are idempotent and use set -euo pipefail
  </success_criteria>

<output>
After completion, create `.planning/phases/08-lxc-container-template-engine/08-03-SUMMARY.md`
</output>
