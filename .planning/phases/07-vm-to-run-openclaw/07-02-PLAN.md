---
phase: 07-vm-to-run-openclaw
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/vm/templates/openclaw-desktop/scripts/00-pre-checks.sh
  - infra/vm/templates/openclaw-desktop/scripts/01-setup-user.sh
  - infra/vm/templates/openclaw-desktop/scripts/02-desktop-setup.sh
  - infra/vm/templates/openclaw-desktop/scripts/03-nodejs-setup.sh
  - infra/vm/templates/openclaw-desktop/scripts/04-chrome-install.sh
  - infra/vm/templates/openclaw-desktop/scripts/05-vnc-setup.sh
  - infra/vm/templates/openclaw-desktop/scripts/06-openclaw-install.sh
  - infra/vm/templates/openclaw-desktop/scripts/99-post-setup.sh
autonomous: true

must_haves:
  truths:
    - "Running all scripts in order on a fresh Debian 13 VM produces a working XFCE desktop with auto-login"
    - "Running 06-openclaw-install.sh results in openclaw being available on the command line"
    - "Re-running any script on an already-configured VM does not break existing state (idempotent)"
    - "Each script can be run individually to fix/reinstall a single component (e.g., just VNC)"
  artifacts:
    - path: "infra/vm/templates/openclaw-desktop/scripts/00-pre-checks.sh"
      provides: "Environment validation and resource checks"
      contains: "Pre-Flight Checks"
    - path: "infra/vm/templates/openclaw-desktop/scripts/02-desktop-setup.sh"
      provides: "XFCE + LightDM auto-login installation"
      contains: "task-xfce-desktop"
    - path: "infra/vm/templates/openclaw-desktop/scripts/03-nodejs-setup.sh"
      provides: "Node.js 22 installation via NodeSource"
      contains: "nodesource"
    - path: "infra/vm/templates/openclaw-desktop/scripts/04-chrome-install.sh"
      provides: "Google Chrome browser installation"
      contains: "google-chrome-stable"
    - path: "infra/vm/templates/openclaw-desktop/scripts/05-vnc-setup.sh"
      provides: "TigerVNC server configuration"
      contains: "vncserver"
    - path: "infra/vm/templates/openclaw-desktop/scripts/06-openclaw-install.sh"
      provides: "OpenClaw npm global installation"
      contains: "openclaw"
    - path: "infra/vm/templates/openclaw-desktop/scripts/99-post-setup.sh"
      provides: "Final validation and welcome message"
      contains: "Post-Setup"
  key_links:
    - from: "infra/vm/templates/openclaw-desktop/scripts/02-desktop-setup.sh"
      to: "LightDM autologin config"
      via: "writes /etc/lightdm/lightdm.conf.d/50-autologin.conf"
      pattern: "autologin-user=openclaw"
    - from: "infra/vm/templates/openclaw-desktop/scripts/05-vnc-setup.sh"
      to: "systemd vncserver service"
      via: "creates and enables vncserver@1.service"
      pattern: "systemctl enable vncserver"
---

<objective>
Create the numbered post-install scripts that run inside the VM to configure the desktop environment and install all required software. These scripts are the CANONICAL source for all software installation — cloud-init (Plan 01) only bootstraps the user and SSH. Scripts are run via run-scripts.sh (Plan 03) after the VM is created.

Purpose: Provide modular, idempotent setup scripts following the existing LXC template convention (infra/lxc/templates/web3-dev/container-configs/scripts/). Each script handles one concern and can be re-run safely.

Output: 8 scripts in `infra/vm/templates/openclaw-desktop/scripts/` covering all locked requirements.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md

# Existing LXC scripts for pattern reference

@infra/lxc/templates/web3-dev/container-configs/scripts/00-pre-checks.sh
@infra/lxc/templates/web3-dev/container-configs/scripts/01-setup-user.sh
@infra/lxc/templates/web3-dev/container-configs/scripts/03-nodejs-setup.sh
@infra/lxc/templates/web3-dev/container-configs/scripts/99-post-setup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-check, user setup, and desktop scripts (00-02)</name>
  <files>
    infra/vm/templates/openclaw-desktop/scripts/00-pre-checks.sh
    infra/vm/templates/openclaw-desktop/scripts/01-setup-user.sh
    infra/vm/templates/openclaw-desktop/scripts/02-desktop-setup.sh
  </files>
  <action>
Create three scripts following the LXC template pattern but adapted for VM context. These scripts assume they run as root inside the Debian 13 VM.

**Important:** Unlike the LXC scripts which use `log_info`/`log_error` from config-manager, these VM scripts should use simple echo-based logging since they run standalone (no config-manager framework). Define a small logging helper at the top of each script or use direct echo with prefixes.

**00-pre-checks.sh:**

- Check running as root
- Check it's Debian 13 (read /etc/os-release, verify VERSION_ID="13" or VERSION_CODENAME="trixie")
- Check minimum resources: ≥2GB RAM, ≥10GB disk, ≥2 CPU cores
- Check network connectivity (ping 8.8.8.8, resolve github.com and deb.nodesource.com)
- Print system summary
- This script should `exit 1` on hard failures (not root, no network) but only warn on resource shortfalls

**01-setup-user.sh:**

- Create `openclaw` user if not exists (UID 1000, shell /bin/bash, groups: sudo, audio, video, render)
- Configure passwordless sudo for script execution: `openclaw ALL=(ALL) NOPASSWD:ALL` (required for automated post-install scripts; user can restrict after setup)
- Set initial password to "openclaw" (using chpasswd) with a note to change it post-setup
- Ensure /home/openclaw exists with correct ownership
- Idempotent: skip user creation if already exists, just verify groups

**02-desktop-setup.sh:**

- Install XFCE desktop: `apt-get install -y task-xfce-desktop lightdm lightdm-gtk-greeter`
- Configure LightDM auto-login: write `/etc/lightdm/lightdm.conf.d/50-autologin.conf` with `autologin-user=openclaw`
- Enable QEMU guest agent: `apt-get install -y qemu-guest-agent && systemctl enable --now qemu-guest-agent`
- Enable LightDM: `systemctl enable lightdm`
- Set default target to graphical: `systemctl set-default graphical.target`
- Idempotent: check if packages are already installed before reinstalling

All scripts should be `chmod +x` and start with `#!/usr/bin/env bash` and `set -euo pipefail`.
</action>
<verify> - All three scripts pass syntax check: `bash -n infra/vm/templates/openclaw-desktop/scripts/0{0,1,2}-*.sh` - All three scripts are executable: `test -x infra/vm/templates/openclaw-desktop/scripts/00-pre-checks.sh` - 00 checks for root and Debian 13 - 01 creates openclaw user with correct groups - 02 installs XFCE and configures auto-login
</verify>
<done> - 00-pre-checks.sh validates VM environment (root, Debian 13, resources, network) - 01-setup-user.sh creates/verifies openclaw user with sudo, audio, video, render groups - 02-desktop-setup.sh installs XFCE + LightDM with auto-login + QEMU guest agent
</done>
</task>

<task type="auto">
  <name>Task 2: Create application install scripts (03-04)</name>
  <files>
    infra/vm/templates/openclaw-desktop/scripts/03-nodejs-setup.sh
    infra/vm/templates/openclaw-desktop/scripts/04-chrome-install.sh
  </files>
  <action>
**03-nodejs-setup.sh:**
- Install Node.js 22 via NodeSource repository (not NVM — keep it simple for a desktop VM)
- Add NodeSource apt repo: `curl -fsSL https://deb.nodesource.com/setup_22.x | bash -`
- Install: `apt-get install -y nodejs`
- Verify: `node --version` and `npm --version`
- Configure npm global prefix for openclaw user to avoid permission issues: set `npm config set prefix /home/openclaw/.npm-global` and add to PATH in .bashrc
- Idempotent: check if node is already installed at correct version

**04-chrome-install.sh:**

- Add Google Chrome GPG key using modern keyring approach (NOT deprecated apt-key):
  `curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg`
- Add Chrome repo: `echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list`
- Install: `apt-get update && apt-get install -y google-chrome-stable`
- Verify: `google-chrome --version`
- Idempotent: skip if already installed

All scripts: `chmod +x`, `#!/usr/bin/env bash`, `set -euo pipefail`.
</action>
<verify> - Both scripts pass syntax check: `bash -n infra/vm/templates/openclaw-desktop/scripts/03-nodejs-setup.sh && bash -n infra/vm/templates/openclaw-desktop/scripts/04-chrome-install.sh` - Both scripts are executable - 03 references nodesource setup_22.x - 04 uses modern GPG keyring (not apt-key)
</verify>
<done> - 03-nodejs-setup.sh installs Node.js 22 via NodeSource with npm global prefix configured - 04-chrome-install.sh installs Chrome with modern GPG keyring approach - Both scripts are idempotent and can run standalone
</done>
</task>

<task type="auto">
  <name>Task 3: Create service and validation scripts (05-06, 99)</name>
  <files>
    infra/vm/templates/openclaw-desktop/scripts/05-vnc-setup.sh
    infra/vm/templates/openclaw-desktop/scripts/06-openclaw-install.sh
    infra/vm/templates/openclaw-desktop/scripts/99-post-setup.sh
  </files>
  <action>
**05-vnc-setup.sh:**

- Install TigerVNC if not already: `apt-get install -y tigervnc-standalone-server tigervnc-tools`
- Create VNC password for openclaw user:
  `sudo -u openclaw mkdir -p /home/openclaw/.vnc`
  `echo "openclaw" | sudo -u openclaw vncpasswd -f > /home/openclaw/.vnc/passwd`
  `chmod 600 /home/openclaw/.vnc/passwd`
- Create xstartup file that launches XFCE:
  ```
  #!/bin/sh
  unset SESSION_MANAGER
  unset DBUS_SESSION_BUS_ADDRESS
  exec startxfce4
  ```
- Create systemd service `/etc/systemd/system/vncserver@.service` (template unit):
  - Type=forking, User=openclaw, ExecStart with `-depth 24 -geometry 1920x1080 -localhost no`
  - Use `-localhost no` so remote connections work
- Enable service: `systemctl enable vncserver@1`
- Idempotent: check if VNC is already configured

**06-openclaw-install.sh:**

- Install OpenClaw globally: `npm install -g openclaw@latest`
- Verify: `openclaw --version` (or `which openclaw`)
- Create a desktop shortcut in /home/openclaw/Desktop/ for easy access (optional .desktop file)
- Idempotent: check if openclaw is already installed

**99-post-setup.sh:**

- Validate all components are installed (node, npm, chrome, vncserver, openclaw, qemu-ga)
- Validate all services are enabled (lightdm, qemu-guest-agent, vncserver@1)
- Clean up: `apt-get clean && apt-get autoremove -y`
- Print welcome message with:
  - VM access info (Proxmox Console, VNC port 5901, SSH)
  - Default credentials (user: openclaw, password: openclaw, VNC password: openclaw)
  - Installed software versions
  - Quick start instructions
- Pattern after the existing 99-post-setup.sh in the LXC template but adapted for VM/desktop context

All scripts: `chmod +x`, `#!/usr/bin/env bash`, `set -euo pipefail`.
</action>
<verify> - All three scripts pass syntax check: `for f in infra/vm/templates/openclaw-desktop/scripts/{05,06,99}-*.sh; do bash -n "$f"; done` - All three scripts are executable - 05 creates vncserver systemd service with `-localhost no` - 06 installs openclaw via npm - 99 validates all components and prints welcome message
</verify>
<done> - 05-vnc-setup.sh configures TigerVNC with systemd service on port 5901 (remote connections enabled) - 06-openclaw-install.sh installs OpenClaw globally via npm - 99-post-setup.sh validates everything and prints welcome message with access details - All scripts are idempotent and can run standalone
</done>
</task>

</tasks>

<verification>
- All 8 scripts exist in `infra/vm/templates/openclaw-desktop/scripts/`
- All scripts pass `bash -n` syntax check
- All scripts are executable (`chmod +x`)
- Scripts cover every locked requirement: desktop (02), auto-login (02), Chrome (04), Node.js (03), VNC (05), QEMU agent (02), OpenClaw (06)
- No script references LXC-specific functions (log_info, run_as_user, config-manager)
</verification>

<success_criteria>

- 8 numbered scripts following the existing LXC template naming convention
- Each script handles one concern and is idempotent
- All locked user requirements are covered by at least one script
- Scripts can be run sequentially as root inside a Debian 13 VM to produce a fully configured desktop environment
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-02-SUMMARY.md`
</output>
