---
phase: 07-vm-to-run-openclaw
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  [
    "apps/dashboard/src/lib/proxmox/vms.ts",
    "apps/dashboard/src/lib/proxmox/schemas.ts",
    "apps/dashboard/src/lib/proxmox/types.ts",
    "apps/dashboard/src/lib/proxmox/index.ts",
  ]
autonomous: true

must_haves:
  truths:
    - "Proxmox API can create VM templates with cloud-init automation"
    - "VM templates support OpenClaw-specific requirements (Node.js, Docker, resources)"
    - "VM configuration validation ensures OpenClaw minimum requirements"
  artifacts:
    - path: "apps/dashboard/src/lib/proxmox/vms.ts"
      provides: "VM creation and template management API"
      exports: ["createVM", "createVMTemplate", "getVMTemplates"]
    - path: "apps/dashboard/src/lib/proxmox/schemas.ts"
      provides: "VM configuration validation schemas"
      exports: ["VMCreateConfigSchema", "VMTemplateSchema"]
  key_links:
    - from: "apps/dashboard/src/lib/proxmox/vms.ts"
      to: "Proxmox VM API endpoints"
      via: "ProxmoxClient HTTP methods"
      pattern: "client\\.(get|post|put).*nodes.*qemu"
---

<objective>
Create Proxmox VM API integration and configuration validation for VM template management.

Purpose: Enable creation and management of VM templates through Proxmox VE API with cloud-init automation support and OpenClaw-specific validation.
Output: Proxmox VM API integration with configuration schemas and type definitions for template system.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md
@.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md
@apps/dashboard/src/lib/proxmox/containers.ts
@apps/dashboard/src/lib/proxmox/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Proxmox VM API integration</name>
  <files>apps/dashboard/src/lib/proxmox/vms.ts</files>
  <action>
    Create VM management API using same patterns as containers.ts:
    
    1. Export functions: listVMs, createVM, deleteVM, getVMStatus, getVMConfig
    2. VM creation supports cloud-init with user-data/vendor-data
    3. Template creation: createVMTemplate() that clones existing VM to template
    4. Use specific Proxmox VM endpoints:
       - GET /nodes/{node}/qemu - list VMs
       - POST /nodes/{node}/qemu - create VM
       - GET /nodes/{node}/qemu/{vmid}/config - get VM config
       - GET /nodes/{node}/qemu/{vmid}/status/current - get VM status
       - DELETE /nodes/{node}/qemu/{vmid} - delete VM
       - POST /nodes/{node}/qemu/{vmid}/template - create template from VM
    5. Support VM-specific configs: UEFI boot, virtio storage, cloud-init drives
    6. Handle VMID auto-assignment similar to containers
    7. Use proper error handling and typing patterns from existing code
    
    Focus on cloud-init automation - vendor-data for OpenClaw installation, user-data for SSH keys.
    Reference research findings for Ubuntu 24.04 + Node.js 22 setup patterns.
  </action>
  <verify>TypeScript compilation succeeds, exports match expected function signatures</verify>
  <done>VM management functions available for template creation and cloud-init automation</done>
</task>

<task type="auto">
  <name>Task 2: Add VM configuration schemas and type definitions</name>
  <files>apps/dashboard/src/lib/proxmox/schemas.ts, apps/dashboard/src/lib/proxmox/types.ts, apps/dashboard/src/lib/proxmox/index.ts</files>
  <action>
    Extend Proxmox schemas and types for VM support:
    
    schemas.ts:
    - VMCreateConfigSchema with VM-specific fields (bios, cpu, machine, memory, storage)
    - CloudInitConfigSchema for user-data/vendor-data validation
    - VMTemplateSchema for template metadata
    
    types.ts:
    - VMCreateConfig interface matching schema
    - VMTemplate, VMStatus, VMConfig interfaces
    - CloudInitConfig interface with userData/vendorData fields
    
    index.ts:
    - Export new VM functions and types
    - Re-export VM schemas for use in server actions
    
    Follow existing patterns from container schemas. VM configs must validate required fields for OpenClaw: memory ≥ 2GB, cores ≥ 2, network interface.
  </action>
  <verify>TypeScript compilation succeeds, schemas validate expected VM configurations</verify>
  <done>VM configuration validation and type definitions available for template system integration</done>
</task>

</tasks>

<verification>
- Proxmox VM API functions can create cloud-init enabled VMs  
- VM configuration schemas validate OpenClaw requirements
- TypeScript compilation passes for all modified files
- VM API integration follows established patterns from container API
</verification>

<success_criteria>

- VM creation API supports cloud-init automation patterns from research
- Configuration validation ensures OpenClaw minimum requirements (2GB RAM, 2 cores, Node.js-ready)
- Proxmox VM API integration ready for template UI integration
- VM template foundation available for OpenClaw template creation
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-02-SUMMARY.md`
</output>
