---
phase: 07-vm-to-run-openclaw
plan: 04
type: execute
wave: 4
depends_on: ["03"]
files_modified:
  [
    "apps/dashboard/src/lib/templates/discovery.ts",
    "apps/dashboard/src/app/(dashboard)/templates/page.tsx",
    "apps/dashboard/src/components/templates/TemplateCard.tsx",
    "apps/dashboard/src/components/templates/TemplateFilters.tsx",
  ]
autonomous: true

must_haves:
  truths:
    - "Template discovery engine finds both LXC and VM templates"
    - "Template browser page displays VM templates alongside LXC templates"
    - "Users can filter templates by type (LXC vs VM)"
    - "VM templates show appropriate metadata and actions"
  artifacts:
    - path: "apps/dashboard/src/lib/templates/discovery.ts"
      provides: "VM template discovery functionality"
      exports: ["discoverTemplates", "syncTemplatesToDatabase"]
    - path: "apps/dashboard/src/app/(dashboard)/templates/page.tsx"
      provides: "Unified template browsing with type filtering"
      min_lines: 100
    - path: "apps/dashboard/src/components/templates/TemplateCard.tsx"
      provides: "Template display supporting both LXC and VM types"
      contains: "templateType"
  key_links:
    - from: "apps/dashboard/src/lib/templates/discovery.ts"
      to: "infra/vm-templates directory scanning"
      via: "filesystem template discovery"
      pattern: "readdir.*vm-templates"
    - from: "apps/dashboard/src/app/(dashboard)/templates/page.tsx"
      to: "template filtering by type"
      via: "search params"
      pattern: "searchParams.*type"
---

<objective>
Integrate VM template discovery and browsing into the existing template management system.

Purpose: Enable users to discover, browse, and manage VM templates through the same interface as LXC templates, with appropriate filtering and display options.
Output: Unified template discovery and browsing system supporting both LXC and VM template types.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md
@.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md
@.planning/phases/07-vm-to-run-openclaw/07-02-SUMMARY.md
@.planning/phases/07-vm-to-run-openclaw/07-03-SUMMARY.md
@apps/dashboard/src/lib/templates/discovery.ts
@apps/dashboard/src/app/(dashboard)/templates/page.tsx
@apps/dashboard/src/components/templates/TemplateCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend template discovery to support VM templates</name>
  <files>apps/dashboard/src/lib/templates/discovery.ts</files>
  <action>
    Extend existing template discovery engine for VM template support:
    
    1. Add VM template directory scanning (infra/vm-templates/) alongside existing LXC scanning
    2. Parse VM template.conf files using same logic as LXC templates
    3. Detect VM-specific configurations: BIOS type, machine type, cloud-init presence
    4. Set templateType="vm" for discovered VM templates vs "lxc" for existing
    5. Validate VM template structure (template.conf + cloud-init directory)
    6. Handle both filesystem layouts:
       - LXC: infra/lxc/templates/{name}/
       - VM: infra/vm-templates/{name}/
    7. Update syncTemplatesToDatabase to handle VM template fields
    8. Preserve existing LXC discovery functionality
    
    Use same error handling and logging patterns as existing discovery code.
    VM template discovery should work even if no VM templates exist yet.
  </action>
  <verify>Discovery finds OpenClaw VM template, database sync creates VM template records</verify>
  <done>Template discovery engine supports both LXC and VM template types from filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Update template browsing page for unified VM/LXC display</name>
  <files>apps/dashboard/src/app/(dashboard)/templates/page.tsx</files>
  <action>
    Extend existing templates page for VM template support:
    
    1. Update database queries to fetch both LXC and VM templates
    2. Add template type filter to search params (?type=lxc|vm|all)
    3. Update search/filter logic to handle templateType field
    4. Maintain existing search by name/description functionality
    5. Add template type indicator to page header (e.g., "23 LXC, 3 VM templates")
    6. Use existing search/filter UI patterns from current implementation
    7. Server-side filtering for performance (URL search params pattern)
    8. Default to showing all template types unless filtered
    
    Preserve all existing functionality - this extends rather than replaces.
    Follow established patterns from current templates page implementation.
  </action>
  <verify>Templates page loads both LXC and VM templates, filtering works by type</verify>
  <done>Template browsing page displays unified view of LXC and VM templates with type-based filtering</done>
</task>

<task type="auto">
  <name>Task 3: Update template display components for VM template support</name>
  <files>apps/dashboard/src/components/templates/TemplateCard.tsx, apps/dashboard/src/components/templates/TemplateFilters.tsx</files>
  <action>
    Update template display components for VM template support:
    
    TemplateCard.tsx:
    1. Display template type badge (LXC vs VM) using shadcn Badge component
    2. Show appropriate metadata for each type:
       - LXC: unprivileged, nesting, keyctl status
       - VM: BIOS type, machine type, cloud-init status
    3. Use appropriate icons/styling for each template type
    4. Maintain existing card layout and functionality
    5. Handle missing VM-specific fields gracefully for LXC templates
    
    TemplateFilters.tsx:
    1. Add template type filter using shadcn Select component
    2. Options: All Templates, LXC Templates, VM Templates
    3. Update filter state management to include templateType
    4. Maintain existing tag and source filtering
    5. Follow established filter UI patterns
    
    Use existing shadcn components throughout - never create custom HTML elements.
    Ensure visual consistency between LXC and VM template displays.
  </action>
  <verify>Template cards show type-specific information, filters work for both template types</verify>
  <done>Template display components support both LXC and VM templates with appropriate metadata and filtering</done>
</task>

</tasks>

<verification>
- Template discovery finds VM templates in infra/vm-templates/ directory
- Templates page displays both LXC and VM templates with unified filtering
- Template cards show type-specific metadata and actions
- OpenClaw VM template appears in template browser with proper VM badges
</verification>

<success_criteria>

- Users can browse VM templates alongside existing LXC templates
- Template discovery automatically detects OpenClaw VM template
- Filter controls allow users to view LXC only, VM only, or all templates
- Template display clearly distinguishes between LXC and VM template types
- Existing LXC template functionality remains unchanged
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-04-SUMMARY.md`
</output>
