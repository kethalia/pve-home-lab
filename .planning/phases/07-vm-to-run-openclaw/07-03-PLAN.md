---
phase: 07-vm-to-run-openclaw
plan: 03
type: execute
wave: 3
depends_on: ["02"]
files_modified:
  [
    "apps/dashboard/src/components/templates/TemplateForm.tsx",
    "apps/dashboard/src/components/templates/VMConfigSection.tsx",
    "apps/dashboard/src/lib/database/templates.ts",
    "apps/dashboard/src/lib/templates/actions.ts",
    "apps/dashboard/src/lib/templates/vm-integration.ts",
    "infra/vm-templates/openclaw/template.conf",
    "infra/vm-templates/openclaw/cloud-init/vendor-data.yaml",
    "infra/vm-templates/openclaw/cloud-init/user-data.yaml",
  ]
autonomous: true

must_haves:
  truths:
    - "Users can create VM templates with OpenClaw-optimized settings through the template creation workflow"
    - "Users can configure VM-specific options (UEFI, machine type, cloud-init) when creating templates"
    - "Users can deploy VM templates with automated OpenClaw installation via cloud-init"
    - "VM template creation validates OpenClaw requirements and stores templates in database"
  artifacts:
    - path: "apps/dashboard/src/components/templates/VMConfigSection.tsx"
      provides: "VM configuration form section"
      min_lines: 80
    - path: "apps/dashboard/src/lib/database/templates.ts"
      provides: "VM template database operations"
      exports: ["createTemplate", "updateTemplate"]
    - path: "apps/dashboard/src/lib/templates/vm-integration.ts"
      provides: "VM template validation to Proxmox API integration"
      exports: ["validateAndCreateVM", "validateAndCreateVMTemplate"]
    - path: "infra/vm-templates/openclaw/cloud-init/vendor-data.yaml"
      provides: "OpenClaw automated installation"
      contains: "curl.*openclaw.*install"
  key_links:
    - from: "apps/dashboard/src/components/templates/TemplateForm.tsx"
      to: "VMConfigSection component"
      via: "conditional render based on templateType"
      pattern: "templateType.*vm.*VMConfigSection"
    - from: "apps/dashboard/src/lib/templates/actions.ts"
      to: "VM template validation"
      via: "Zod schema validation"
      pattern: "VMTemplateSchema"
    - from: "apps/dashboard/src/lib/templates/vm-integration.ts"
      to: "Plan 02 Proxmox VM API"
      via: "import and function calls"
      pattern: "import.*vms.*createVM"
---

<objective>
Extend the template creation UI to support VM templates and create a production-ready OpenClaw VM template.

Purpose: Enable users to create VM templates through the existing template form interface, and provide an OpenClaw template ready for deployment with cloud-init automation.
Output: Extended template form supporting VM configuration, plus OpenClaw VM template with automated Node.js setup.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md
@.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md
@.planning/phases/07-vm-to-run-openclaw/07-02-SUMMARY.md
@apps/dashboard/src/components/templates/TemplateForm.tsx
@apps/dashboard/src/lib/database/templates.ts
@apps/dashboard/src/lib/templates/actions.ts
@apps/dashboard/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VM configuration form section</name>
  <files>apps/dashboard/src/components/templates/VMConfigSection.tsx</files>
  <action>
    Create VM-specific configuration form section following shadcn/ui patterns:
    
    1. Use FormField, FormItem, FormLabel, FormControl, FormMessage from shadcn Form
    2. VM configuration fields:
       - BIOS Type: Select (SeaBIOS, OVMF/UEFI) 
       - CPU Type: Select (host, kvm64, x86-64-v2-AES) with descriptions
       - Machine Type: Select (pc, q35) - q35 for UEFI, pc for legacy
       - Memory: Input with min 1GB, recommended 4GB for OpenClaw
       - Storage: Select for cloud-init ISO storage location  
       - Network: Bridge configuration (vmbr0, vmbr1, etc.)
    3. Use shadcn Select, Input, Label components - never raw HTML
    4. Include helper text explaining OpenClaw requirements (2+ cores, 2GB+ RAM)
    5. Validate minimum requirements in form validation
    6. Default to OpenClaw-optimized settings: UEFI, q35, 4GB RAM, 2 cores
    
    Export as default component for use in TemplateForm.
  </action>
  <verify>Component compiles, renders form fields using shadcn components</verify>
  <done>VM configuration form section available with OpenClaw-optimized defaults</done>
</task>

<task type="auto">
  <name>Task 2: Extend template form and database service for VM support</name>
  <files>apps/dashboard/src/components/templates/TemplateForm.tsx, apps/dashboard/src/lib/database/templates.ts, apps/dashboard/src/lib/templates/actions.ts</files>
  <action>
    Extend existing template system for VM template support:
    
    TemplateForm.tsx:
    1. Add templateType field using shadcn Select (LXC, VM) 
    2. Conditionally render VMConfigSection when templateType==="vm"
    3. Update form schema to include VM fields (biosType, cpuType, etc.)
    4. Maintain existing LXC sections for backward compatibility
    5. Use controlled form pattern with react-hook-form + zodResolver
    
    templates.ts (DatabaseService):
    1. Update createTemplate/updateTemplate to handle VM fields
    2. Set proper defaults for VM templates (templateType, UEFI defaults)
    3. Validate VM-specific constraints (memory â‰¥ 1GB, etc.)
    4. Handle both LXC and VM template creation in same methods
    
    actions.ts:
    1. Update createTemplateAction/updateTemplateAction schemas
    2. Add VM field validation using imported VMTemplateSchema
    3. Ensure server actions work with both template types
    
    Preserve all existing LXC functionality - this is additive, not replacement.
  </action>
  <verify>Template form shows VM section when VM type selected, database operations handle both types</verify>
  <done>Template creation system supports both LXC and VM templates with type-specific validation</done>
</task>

<task type="auto">
  <name>Task 3: Create OpenClaw VM template with cloud-init automation</name>
  <files>infra/vm-templates/openclaw/template.conf, infra/vm-templates/openclaw/cloud-init/vendor-data.yaml, infra/vm-templates/openclaw/cloud-init/user-data.yaml</files>
  <action>
    Create production-ready OpenClaw VM template following research patterns:
    
    template.conf (similar to LXC template.conf):
    1. Template metadata: name, description, tags
    2. VM defaults: 4GB RAM, 2 cores, 32GB disk, Ubuntu 24.04
    3. UEFI settings: ovmf bios, q35 machine, virtio-scsi storage
    4. Network: vmbr0 bridge with DHCP
    5. Cloud-init storage configuration
    
    vendor-data.yaml:
    1. OpenClaw installation automation per research:
       - Update system packages
       - Install Node.js 22+ via NodeSource repository
       - Install Docker and add openclaw user to docker group
       - Download and install OpenClaw via official installer script
       - Configure OpenClaw as systemd service
       - Set up basic firewall rules (SSH, OpenClaw ports)
    
    user-data.yaml:
    1. Basic cloud-init user configuration:
       - Create openclaw user with sudo access
       - SSH key injection (templated)
       - Disable root SSH, enable SSH for openclaw user
       - Set hostname and locale
    
    Follow cloud-init best practices from research. Installation script must be idempotent.
  </action>
  <verify>YAML files pass cloud-init validation, template.conf follows established patterns</verify>
  <done>OpenClaw VM template ready for automated deployment with Node.js 22+ and Docker support</done>
</task>

<task type="auto">
  <name>Task 4: Wire VM template validation to Proxmox API integration</name>
  <files>apps/dashboard/src/lib/templates/vm-integration.ts</files>
  <action>
    Create integration layer connecting VM template validation to Proxmox API calls:
    
    1. Import VMCreateConfigSchema from Plan 02 schemas
    2. Import createVM, createVMTemplate functions from Plan 02 vms.ts
    3. Create validateAndCreateVM function:
       - Validates VM template config using VMCreateConfigSchema
       - Transforms validated data to Proxmox VM creation format
       - Calls createVM from vms.ts with proper parameters
       - Handles validation errors and API errors consistently
    4. Create validateAndCreateVMTemplate function:
       - Validates template configuration
       - Calls createVMTemplate from vms.ts
       - Returns template creation result
    5. Export functions for use in template creation server actions
    
    This wires the validation schemas from Plan 02 to actual VM creation functionality,
    ensuring form validation aligns with Proxmox API requirements.
  </action>
  <verify>Integration functions validate VM configs and successfully call Proxmox API functions</verify>
  <done>VM template validation properly wired to Proxmox API integration layer</done>
</task>

</tasks>

<verification>
- Template form shows VM configuration section when VM type selected
- Database operations handle both LXC and VM template creation
- OpenClaw VM template includes working cloud-init automation
- Form validation enforces OpenClaw minimum requirements
- VM template validation properly integrates with Proxmox API
</verification>

<success_criteria>

- Users can create VM templates using existing template creation workflow
- VM configuration form provides OpenClaw-optimized defaults
- OpenClaw VM template automates complete Node.js + Docker setup
- Template creation maintains backward compatibility with existing LXC templates
- VM template validation connects to Proxmox API integration
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-03-SUMMARY.md`
</output>
