---
phase: 07-vm-to-run-openclaw
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - infra/vm/templates/openclaw-desktop/run-scripts.sh
  - infra/vm/templates/openclaw-desktop/README.md
autonomous: true

must_haves:
  truths:
    - "Running ./run-scripts.sh <VM_IP> installs the complete desktop environment on a bootstrapped VM"
    - "README documents the full workflow: create VM → wait for cloud-init bootstrap → run scripts for desktop software"
    - "A user following the README can go from nothing to a working OpenClaw desktop VM"
  artifacts:
    - path: "infra/vm/templates/openclaw-desktop/run-scripts.sh"
      provides: "Script runner that executes all numbered scripts inside a VM via SSH"
      contains: "ssh"
    - path: "infra/vm/templates/openclaw-desktop/README.md"
      provides: "Template documentation with usage instructions"
      contains: "OpenClaw Desktop"
  key_links:
    - from: "infra/vm/templates/openclaw-desktop/run-scripts.sh"
      to: "infra/vm/templates/openclaw-desktop/scripts/*.sh"
      via: "scp + ssh execution"
      pattern: "scripts/.*\\.sh"
    - from: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      to: "infra/vm/templates/openclaw-desktop/run-scripts.sh"
      via: "documented workflow (create-vm first, then optionally run-scripts)"
      pattern: "run-scripts"
---

<objective>
Create the script runner (run-scripts.sh) that orchestrates executing all post-install scripts inside a running VM via SSH, plus comprehensive README documentation for the template.

Purpose: Complete the template by providing (1) the PRIMARY path for installing desktop software on a VM that was bootstrapped by cloud-init (which only sets up user + SSH), and (2) documentation that explains the full two-step workflow (create-vm.sh → run-scripts.sh).

Output: run-scripts.sh orchestrator and README.md documentation.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md
@.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md
@.planning/phases/07-vm-to-run-openclaw/07-02-SUMMARY.md

# Existing LXC README for documentation pattern

@infra/lxc/templates/web3-dev/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create run-scripts.sh orchestrator</name>
  <files>
    infra/vm/templates/openclaw-desktop/run-scripts.sh
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/run-scripts.sh` — a helper script that copies all post-install scripts to a running VM and executes them in order.

This is the PRIMARY path for installing desktop software on the VM. Cloud-init only bootstraps the user and SSH — this script does all the heavy lifting.

Use cases:

- **Primary:** Run after create-vm.sh to install desktop environment and all software
- **Re-run:** Re-run to fix/reinstall components after making changes to scripts
- **Manual VM:** Run on any Debian 13 VM (even one not created by create-vm.sh)

The script should:

1. Accept a VM IP address or VMID as argument
2. If VMID given, resolve the IP via `qm guest exec` or `qm agent`
3. Copy all scripts from `scripts/` to the VM via SCP
4. SSH into the VM and run each script in numbered order
5. Report success/failure for each script

```bash
#!/usr/bin/env bash
# run-scripts.sh — Execute post-install scripts on a running OpenClaw Desktop VM
#
# Usage:
#   ./run-scripts.sh <VM_IP>           — Run all scripts via SSH
#   ./run-scripts.sh <VM_IP> <script>  — Run a specific script (e.g., 03-nodejs-setup.sh)
#
# Prerequisites:
#   - VM must be running and accessible via SSH
#   - SSH key or password auth must be configured
#   - Scripts are run as root (uses sudo if not already root)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="${SCRIPT_DIR}/scripts"
REMOTE_DIR="/tmp/openclaw-setup"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

usage() {
    echo "Usage: $0 <VM_IP> [script_name]"
    echo ""
    echo "Arguments:"
    echo "  VM_IP       IP address of the target VM"
    echo "  script_name Optional: run only this script (e.g., 03-nodejs-setup.sh)"
    echo ""
    echo "Examples:"
    echo "  $0 192.168.1.100              # Run all scripts"
    echo "  $0 192.168.1.100 05-vnc-setup.sh  # Run only VNC setup"
    exit 1
}

if [[ $# -lt 1 ]]; then
    usage
fi

VM_IP="$1"
SINGLE_SCRIPT="${2:-}"
SSH_USER="root"
SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=10"

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  OpenClaw Desktop — Script Runner${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo "Target: ${VM_IP}"
echo ""

# Test SSH connectivity
echo -n "Testing SSH connection... "
if ssh ${SSH_OPTS} ${SSH_USER}@${VM_IP} "echo ok" >/dev/null 2>&1; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo ""
    echo "Cannot connect to ${VM_IP} via SSH."
    echo "Ensure the VM is running and SSH is accessible."
    echo ""
    echo "Try: ssh ${SSH_USER}@${VM_IP}"
    exit 1
fi

# Create remote directory
ssh ${SSH_OPTS} ${SSH_USER}@${VM_IP} "mkdir -p ${REMOTE_DIR}"

# Copy scripts to VM
echo "Copying scripts to VM..."
scp ${SSH_OPTS} -q "${SCRIPTS_DIR}"/*.sh ${SSH_USER}@${VM_IP}:${REMOTE_DIR}/
echo -e "${GREEN}Scripts copied to ${REMOTE_DIR}${NC}"
echo ""

# Determine which scripts to run
if [[ -n "$SINGLE_SCRIPT" ]]; then
    SCRIPTS=("${SINGLE_SCRIPT}")
else
    # Get scripts in numbered order
    SCRIPTS=($(ls -1 "${SCRIPTS_DIR}"/*.sh | xargs -I{} basename {} | sort))
fi

# Execute scripts
FAILED=0
for script in "${SCRIPTS[@]}"; do
    echo -e "Running ${YELLOW}${script}${NC}..."

    if ssh ${SSH_OPTS} ${SSH_USER}@${VM_IP} "chmod +x ${REMOTE_DIR}/${script} && bash ${REMOTE_DIR}/${script}" 2>&1; then
        echo -e "${GREEN}✓ ${script} completed${NC}"
    else
        echo -e "${RED}✗ ${script} failed${NC}"
        FAILED=$((FAILED + 1))

        # Ask whether to continue
        if [[ -z "$SINGLE_SCRIPT" ]]; then
            echo ""
            read -p "Continue with remaining scripts? [Y/n] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Nn]$ ]]; then
                echo "Aborted."
                exit 1
            fi
        fi
    fi
    echo ""
done

# Cleanup
ssh ${SSH_OPTS} ${SSH_USER}@${VM_IP} "rm -rf ${REMOTE_DIR}" 2>/dev/null || true

echo "============================================"
if [[ $FAILED -eq 0 ]]; then
    echo -e "${GREEN}All scripts completed successfully!${NC}"
else
    echo -e "${YELLOW}${FAILED} script(s) failed. Review output above.${NC}"
fi
echo "============================================"
```

Make executable: `chmod +x run-scripts.sh`
</action>
<verify> - `bash -n infra/vm/templates/openclaw-desktop/run-scripts.sh` — no syntax errors - `test -x infra/vm/templates/openclaw-desktop/run-scripts.sh` — is executable - Script accepts VM_IP argument (grep for usage function) - Script copies and executes scripts via SSH (grep for "scp" and "ssh")
</verify>
<done> - run-scripts.sh accepts a VM IP and optional single-script argument - Copies all scripts from scripts/ directory to the VM via SCP - Executes scripts in numbered order via SSH - Reports success/failure for each script with colored output - Handles failures gracefully with option to continue
</done>
</task>

<task type="auto">
  <name>Task 2: Create README.md documentation</name>
  <files>
    infra/vm/templates/openclaw-desktop/README.md
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/README.md` documenting the template.

Follow the documentation style of `infra/lxc/templates/web3-dev/README.md` but adapted for VM context.

Include these sections:

1. **Header** — OpenClaw Desktop VM Template title, one-line description
2. **Overview** — What this template creates (Debian 13 VM with XFCE desktop for OpenClaw). Explain the two-phase architecture: cloud-init handles minimal bootstrap (user, SSH), then run-scripts.sh installs all desktop software via numbered scripts.
3. **Requirements** — Proxmox VE 8+, internet access, storage with enough space
4. **Quick Start** — The three-step workflow:
   - `bash create-vm.sh` (creates VM, cloud-init bootstraps user + SSH in ~2-3 min)
   - Get VM IP: `qm guest cmd <VMID> network-get-interfaces`
   - `./run-scripts.sh <VM_IP>` (installs all desktop software ~15-20 min)
5. **What Gets Installed** — Table of all software: XFCE, LightDM, Chrome, Node.js 22, TigerVNC, QEMU agent, OpenClaw
6. **File Structure** — Tree view of template directory
7. **Configuration** — How to customize via template.conf (resources, hostname, etc.)
8. **Accessing the VM** — Three methods:
   - Proxmox Console (built-in noVNC in web UI)
   - VNC client on port 5901 (password: openclaw)
   - SSH: `ssh openclaw@VM_IP`
9. **Manual Setup** — Using run-scripts.sh for manual/re-run scenarios
10. **Default Credentials** — Table with user/password/VNC password
11. **Troubleshooting** — Common issues:
    - Cloud-init didn't complete: check `/var/log/cloud-init-output.log`
    - Black screen: check LightDM service, display adapter settings
    - VNC won't connect: check vncserver@1 service, firewall
    - Chrome won't start: needs --no-sandbox if running as root
12. **Resource Recommendations** — Table: minimum vs recommended for RAM, CPU, disk

Keep the README practical and concise. Focus on "how to use" not "how it works internally."
</action>
<verify> - `test -f infra/vm/templates/openclaw-desktop/README.md` - README contains Quick Start section - README contains Default Credentials section - README contains Troubleshooting section - README references create-vm.sh and run-scripts.sh
</verify>
<done> - README.md provides complete documentation for the VM template - Quick Start shows how to create a VM in two steps - All access methods documented (Proxmox Console, VNC, SSH) - Default credentials clearly listed - Troubleshooting covers common desktop VM issues
</done>
</task>

</tasks>

<verification>
- `ls infra/vm/templates/openclaw-desktop/` shows: create-vm.sh, template.conf, cloud-init/, scripts/, run-scripts.sh, README.md
- run-scripts.sh passes bash syntax check and is executable
- README.md documents the complete workflow from VM creation to access
- All template files are self-consistent (README references actual scripts and files)
</verification>

<success_criteria>

- run-scripts.sh provides manual/re-run capability for post-install scripts
- README.md is a complete, practical guide for using the template
- The template is fully documented and usable end-to-end
- A user can go from nothing to a working OpenClaw desktop VM following the README
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-03-SUMMARY.md`
</output>
