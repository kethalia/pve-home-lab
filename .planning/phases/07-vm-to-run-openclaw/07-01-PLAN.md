---
phase: 07-vm-to-run-openclaw
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/vm/templates/openclaw-desktop/template.conf
  - infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml
  - infra/vm/templates/openclaw-desktop/create-vm.sh
autonomous: true

must_haves:
  truths:
    - "Running create-vm.sh creates a Debian 13 desktop VM with cloud-init bootstrapping the openclaw user"
    - "Cloud-init only handles minimal bootstrap (user, SSH, basic packages) — scripts are the single source of truth for software"
    - "After VM creation, user can run run-scripts.sh or SSH in to install all desktop software via the numbered scripts"
  artifacts:
    - path: "infra/vm/templates/openclaw-desktop/template.conf"
      provides: "VM template metadata and resource defaults"
      contains: "TEMPLATE_APP"
    - path: "infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml"
      provides: "Minimal cloud-init bootstrap (user, SSH, basic packages only — NO software installation)"
      contains: "#cloud-config"
    - path: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      provides: "VM creation wrapper script"
      contains: "debian-13-vm.sh"
  key_links:
    - from: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      to: "infra/vm/templates/openclaw-desktop/template.conf"
      via: "source template.conf"
      pattern: "source.*template\\.conf"
    - from: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      to: "community-scripts/ProxmoxVE debian-13-vm.sh"
      via: "bash -c subshell (intentional — community VM scripts are interactive/whiptail-based, unlike LXC scripts which can be sourced)"
      pattern: "debian-13-vm"
    - from: "infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml"
      to: "infra/vm/templates/openclaw-desktop/scripts/*.sh"
      via: "cloud-init does NOT install software — scripts are canonical; documented in README"
      pattern: "run-scripts"
---

<objective>
Create the VM template directory structure with configuration metadata, minimal cloud-init bootstrap, and the VM creation wrapper script that uses the ProxmoxVE community Debian 13 VM script as its foundation.

Purpose: Establish the VM template scaffolding following the same pattern as the existing LXC template (infra/lxc/templates/web3-dev/), adapted for VM-specific concerns (cloud-init, UEFI boot, virtio drivers, desktop resources). Cloud-init is intentionally minimal (user + SSH + basic packages) — all software installation happens via post-install scripts (Plan 02).

Output: Three files — template.conf (metadata), cloud-init/user-data.yaml (minimal bootstrap only), and create-vm.sh (entry point that wraps the community script).
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md

# Existing LXC template for pattern reference

@infra/lxc/templates/web3-dev/template.conf
@infra/lxc/templates/web3-dev/container.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template.conf and cloud-init user-data.yaml</name>
  <files>
    infra/vm/templates/openclaw-desktop/template.conf
    infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/template.conf` following the exact pattern of `infra/lxc/templates/web3-dev/template.conf` but adapted for VM:

```bash
#!/usr/bin/env bash
# OpenClaw Desktop VM Template Configuration

# Template identification
TEMPLATE_APP="OpenClaw Desktop"
TEMPLATE_TAGS="openclaw;desktop;xfce;nodejs;chrome"
TEMPLATE_DESCRIPTION="Desktop VM with XFCE, Chrome, Node.js for running OpenClaw GUI applications"

# VM configuration path (relative to repository root)
TEMPLATE_CONFIG_PATH="infra/vm/templates/openclaw-desktop"

# Resource defaults (desktop-appropriate — higher than server defaults)
TEMPLATE_CPU="${TEMPLATE_CPU:-4}"
TEMPLATE_RAM="${TEMPLATE_RAM:-4096}"
TEMPLATE_DISK="${TEMPLATE_DISK:-32G}"
TEMPLATE_OS="${TEMPLATE_OS:-debian}"
TEMPLATE_VERSION="${TEMPLATE_VERSION:-13}"

# VM-specific settings
TEMPLATE_MACHINE="${TEMPLATE_MACHINE:-q35}"
TEMPLATE_BIOS="${TEMPLATE_BIOS:-ovmf}"
TEMPLATE_DISPLAY="${TEMPLATE_DISPLAY:-virtio}"
TEMPLATE_CPU_TYPE="${TEMPLATE_CPU_TYPE:-host}"
TEMPLATE_CLOUD_INIT="${TEMPLATE_CLOUD_INIT:-yes}"
TEMPLATE_START_VM="${TEMPLATE_START_VM:-yes}"

# User configuration
TEMPLATE_USER="${TEMPLATE_USER:-openclaw}"
TEMPLATE_HOSTNAME="${TEMPLATE_HOSTNAME:-openclaw-desktop}"
```

Create `infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml` as a **MINIMAL** cloud-init config.

**CRITICAL DESIGN DECISION:** Cloud-init is ONLY for minimal bootstrap. ALL software installation (XFCE, Chrome, Node.js, VNC, OpenClaw) happens exclusively via the numbered scripts in Plan 02. This avoids dual provisioning — scripts are the single source of truth.

Cloud-init handles ONLY:

- User creation (openclaw with sudo)
- Password setup
- SSH enablement
- Basic packages (curl, git, ca-certificates — prerequisites for scripts)
- QEMU guest agent (needed for Proxmox integration before scripts run)

```yaml
#cloud-config
# MINIMAL BOOTSTRAP ONLY — software installation is handled by post-install scripts
# See: scripts/*.sh for all software (XFCE, Chrome, Node.js, VNC, OpenClaw)
hostname: openclaw-desktop
manage_etc_hosts: true

users:
  - name: openclaw
    groups: sudo,audio,video,render
    shell: /bin/bash
    sudo: ALL=(ALL) ALL
    lock_passwd: false

package_update: true

packages:
  # Minimal bootstrap packages only — NOT desktop software
  - qemu-guest-agent # Proxmox integration (needed before scripts)
  - openssh-server # SSH access (needed to run scripts remotely)
  - curl # Script prerequisite
  - wget # Script prerequisite
  - ca-certificates # Script prerequisite
  - gnupg # Script prerequisite
  - git # Script prerequisite
  - sudo # Script prerequisite

runcmd:
  # Enable QEMU guest agent for Proxmox integration
  - systemctl enable --now qemu-guest-agent
  # Set initial openclaw user password — MUST be changed on first login
  # Post-install script 01-setup-user.sh will configure passwordless sudo for script execution
  - echo "openclaw:openclaw" | chpasswd
  - chage -d 0 openclaw # Force password change on first interactive login
  # Ensure SSH is running for remote script execution
  - systemctl enable --now ssh

final_message: "OpenClaw Desktop VM bootstrap complete after $UPTIME seconds. Run post-install scripts to set up desktop environment."
```

Do NOT add any desktop packages, Node.js, Chrome, VNC, or application installs to cloud-init. Those belong in the scripts/ directory (Plan 02).
</action>
<verify> - `cat infra/vm/templates/openclaw-desktop/template.conf` shows all TEMPLATE\_\* variables - `cat infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml` starts with `#cloud-config` - Verify cloud-init YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml'))"` - Verify template.conf is valid bash: `bash -n infra/vm/templates/openclaw-desktop/template.conf` - Verify cloud-init does NOT contain desktop packages: `! grep -q 'task-xfce-desktop\|google-chrome\|nodesource\|tigervnc\|openclaw' infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml`
</verify>
<done> - template.conf defines TEMPLATE_APP="OpenClaw Desktop" with desktop-appropriate resources (4 CPU, 4096 RAM, 32G disk) - cloud-init user-data.yaml is MINIMAL: creates openclaw user with sudo, installs only bootstrap packages (curl, git, ca-certs, qemu-guest-agent, openssh-server) - cloud-init does NOT install XFCE, Chrome, Node.js, VNC, or OpenClaw (those are in scripts/)
</done>
</task>

<task type="auto">
  <name>Task 2: Create VM creation wrapper script (create-vm.sh)</name>
  <files>
    infra/vm/templates/openclaw-desktop/create-vm.sh
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/create-vm.sh` — the main entry point for creating an OpenClaw Desktop VM.

This script should:

1. Source `template.conf` for defaults
2. Display a header/banner for the OpenClaw Desktop template
3. Override the community script defaults with our desktop-appropriate values
4. Call the community Debian 13 VM script with `CLOUD_INIT=yes` to create the base VM
5. After the community script completes, copy the cloud-init user-data.yaml to the Proxmox snippets directory
6. Apply the cloud-init config to the VM
7. If the VM was started by the community script, restart it so cloud-init runs with our config

Key implementation details:

- **Why `bash -c` subshell (not `source`):** Community VM scripts work differently from LXC scripts. They use whiptail for interactive configuration and don't read env vars the same way as LXC build.func. The `bash -c` approach is correct for VM scripts — you can't `source` them like LXC container.sh. This is an intentional difference from the LXC pattern.
- The community script is interactive (whiptail) — we want to let the user go through it but with our defaults pre-set via env vars (which whiptail dialogs may or may not honor)
- Since `bash -c` runs in a subshell, we CANNOT capture the community script's `$VMID` variable. Instead, we detect the created VM by searching `qm list` for our hostname after the script completes. This is reliable because the community script sets the hostname.
- After the community script finishes, we apply our cloud-init config
- The script should work when run from the Proxmox host shell
- **Post-creation workflow:** After cloud-init bootstraps the VM (user + SSH + basic packages), the user runs `run-scripts.sh` to install all desktop software. The README documents this two-step workflow.

Structure:

```bash
#!/usr/bin/env bash
# OpenClaw Desktop VM Creator
# Creates a Debian 13 VM with desktop environment for OpenClaw
#
# Usage: bash create-vm.sh
# Must be run on the Proxmox host as root.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source template configuration
source "${SCRIPT_DIR}/template.conf"

echo "============================================"
echo "  OpenClaw Desktop VM Creator"
echo "============================================"
echo ""
echo "Phase 1 — Bootstrap (this script):"
echo "  - Creates Debian 13 VM via community script"
echo "  - Cloud-init configures: openclaw user, SSH, basic packages"
echo ""
echo "Phase 2 — Desktop Setup (run-scripts.sh):"
echo "  - XFCE desktop environment + auto-login"
echo "  - Google Chrome browser"
echo "  - Node.js 22+ runtime"
echo "  - TigerVNC remote access (port 5901)"
echo "  - QEMU guest agent"
echo "  - OpenClaw (installed globally)"
echo ""
echo "Resource defaults: ${TEMPLATE_CPU} cores, ${TEMPLATE_RAM}MB RAM, ${TEMPLATE_DISK} disk"
echo ""

# Pre-set environment variables that the community script MAY read.
# NOTE: Community VM scripts use whiptail dialogs and may not honor all env vars.
# The user can adjust values in the interactive dialog if these don't take effect.
export var_cpu="${TEMPLATE_CPU}"
export var_ram="${TEMPLATE_RAM}"
export DISK_SIZE="${TEMPLATE_DISK}"
export HN="${TEMPLATE_HOSTNAME}"
export CLOUD_INIT="yes"
export START_VM="${TEMPLATE_START_VM}"

# Run the community Debian 13 VM script
# This handles: VM creation, storage selection, networking, disk import
echo "Launching Proxmox community script for base Debian 13 VM..."
echo "(You can accept defaults or customize in the dialog)"
echo ""

# INTEGRATION NOTE: We use bash -c (subshell), NOT source.
# Community VM scripts are interactive (whiptail-based) and work differently
# from LXC community scripts which use build.func and can be sourced.
# The tradeoff: we cannot capture $VMID from the subshell, so we detect
# the created VM by hostname after the script completes.
bash -c "$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/vm/debian-13-vm.sh)"

# Detect the created VM by hostname.
# We can't read $VMID from the subshell, so we search qm list.
# This is reliable because the community script sets the hostname we specified.
VMID=$(qm list | grep "${TEMPLATE_HOSTNAME}" | awk '{print $1}' | tail -1)

if [[ -z "$VMID" ]]; then
  echo "ERROR: Could not find created VM. Looking for hostname '${TEMPLATE_HOSTNAME}'"
  echo "Available VMs:"
  qm list
  exit 1
fi

echo ""
echo "Found VM ${VMID} (${TEMPLATE_HOSTNAME})"

# Copy cloud-init user-data to Proxmox snippets directory
SNIPPETS_DIR="/var/lib/vz/snippets"
mkdir -p "${SNIPPETS_DIR}"

CLOUD_INIT_FILE="${SCRIPT_DIR}/cloud-init/user-data.yaml"
SNIPPET_NAME="openclaw-desktop-${VMID}.yaml"

if [[ ! -f "$CLOUD_INIT_FILE" ]]; then
  echo "ERROR: Cloud-init config not found at ${CLOUD_INIT_FILE}"
  exit 1
fi

cp "${CLOUD_INIT_FILE}" "${SNIPPETS_DIR}/${SNIPPET_NAME}"
echo "Cloud-init config copied to ${SNIPPETS_DIR}/${SNIPPET_NAME}"

# Apply cloud-init custom config to the VM
qm set "${VMID}" --cicustom "user=local:snippets/${SNIPPET_NAME}"

# Set display to virtio for better desktop performance
qm set "${VMID}" --vga "${TEMPLATE_DISPLAY}"

echo ""
echo "Cloud-init configuration applied to VM ${VMID}"

# If VM is already running, stop and restart to pick up cloud-init
if qm status "${VMID}" | grep -q "running"; then
  echo "Restarting VM to apply cloud-init configuration..."
  qm shutdown "${VMID}" --timeout 30 2>/dev/null || qm stop "${VMID}"
  sleep 3
  qm start "${VMID}"
  echo "VM restarted with cloud-init configuration"
elif [[ "${TEMPLATE_START_VM}" == "yes" ]]; then
  echo "Starting VM ${VMID}..."
  qm start "${VMID}"
fi

echo ""
echo "============================================"
echo "  OpenClaw Desktop VM Created!"
echo "============================================"
echo ""
echo "VM ID: ${VMID}"
echo "Hostname: ${TEMPLATE_HOSTNAME}"
echo ""
echo "Cloud-init is bootstrapping the VM (user, SSH, basic packages)."
echo "This takes ~2-3 minutes. Check progress:"
echo "  qm guest exec ${VMID} -- cat /var/log/cloud-init-output.log"
echo ""
echo "NEXT STEP: Install desktop software via post-install scripts:"
echo "  1. Wait for cloud-init to finish (VM will have SSH access)"
echo "  2. Get the VM IP: qm guest cmd ${VMID} network-get-interfaces"
echo "  3. Run: ./run-scripts.sh <VM_IP>"
echo ""
echo "This installs XFCE, Chrome, Node.js, VNC, and OpenClaw (~15-20 min)."
echo ""
echo "Default credentials:"
echo "  User: openclaw"
echo "  Password: openclaw"
echo ""
echo "============================================"
```

Make the script executable: `chmod +x create-vm.sh`

IMPORTANT INTEGRATION NOTES:

1. The community script runs in a subshell via `bash -c` (not `source`) because VM community scripts are interactive/whiptail-based — this differs from the LXC pattern intentionally.
2. We detect the created VM by searching `qm list` for our hostname since `$VMID` from the subshell is not accessible. This is reliable because the community script sets the hostname.
3. Cloud-init is intentionally minimal — it only creates the user and sets up SSH. All desktop software (XFCE, Chrome, Node.js, VNC, OpenClaw) is installed by the numbered scripts in scripts/ via run-scripts.sh.
   </action>
   <verify> - `bash -n infra/vm/templates/openclaw-desktop/create-vm.sh` — no syntax errors - `test -x infra/vm/templates/openclaw-desktop/create-vm.sh` — is executable - Script sources template.conf (grep for "source.\*template.conf") - Script references community Debian 13 VM script (grep for "debian-13-vm.sh") - Script handles cloud-init snippet deployment (grep for "cicustom")
   </verify>
   <done> - create-vm.sh is executable and sources template.conf for defaults - Script runs the community Debian 13 VM script via curl - After VM creation, script copies cloud-init user-data.yaml to /var/lib/vz/snippets/ - Script applies cloud-init config via `qm set --cicustom` - Script sets virtio display for desktop performance - Script outputs clear instructions for monitoring cloud-init progress and accessing the VM
   </done>
   </task>

</tasks>

<verification>
- Directory structure exists: `ls -la infra/vm/templates/openclaw-desktop/`
- All scripts pass bash syntax check: `bash -n infra/vm/templates/openclaw-desktop/create-vm.sh && bash -n infra/vm/templates/openclaw-desktop/template.conf`
- Cloud-init YAML is valid
- template.conf defines all required TEMPLATE_* variables
- create-vm.sh is executable and references both template.conf and community script
</verification>

<success_criteria>

- `infra/vm/templates/openclaw-desktop/` directory exists with template.conf, create-vm.sh, cloud-init/user-data.yaml
- template.conf mirrors LXC template pattern with VM-specific additions (machine type, BIOS, display, cloud-init)
- cloud-init is MINIMAL: creates openclaw user, sets up SSH, installs bootstrap packages (curl, git, qemu-guest-agent) — does NOT install desktop software
- create-vm.sh wraps the community Debian 13 VM script and applies cloud-init post-creation
- Post-creation output instructs user to run run-scripts.sh for desktop software installation
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md`
</output>
