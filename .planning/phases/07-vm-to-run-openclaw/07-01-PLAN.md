---
phase: 07-vm-to-run-openclaw
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  [
    "apps/dashboard/prisma/schema.prisma",
    "apps/dashboard/src/lib/proxmox/vms.ts",
    "apps/dashboard/src/lib/proxmox/schemas.ts",
    "apps/dashboard/src/lib/proxmox/types.ts",
    "apps/dashboard/src/lib/proxmox/index.ts",
  ]
autonomous: true

must_haves:
  truths:
    - "Database can store VM template configuration alongside LXC templates"
    - "Proxmox API can create VM templates with cloud-init automation"
    - "VM templates support OpenClaw-specific requirements (Node.js, Docker, resources)"
  artifacts:
    - path: "apps/dashboard/prisma/schema.prisma"
      provides: "Extended Template model with VM support"
      contains: "templateType"
    - path: "apps/dashboard/src/lib/proxmox/vms.ts"
      provides: "VM creation and template management API"
      exports: ["createVM", "createVMTemplate", "getVMTemplates"]
    - path: "apps/dashboard/src/lib/proxmox/schemas.ts"
      provides: "VM configuration validation schemas"
      exports: ["VMCreateConfigSchema", "VMTemplateSchema"]
  key_links:
    - from: "apps/dashboard/src/lib/proxmox/vms.ts"
      to: "Proxmox VM API endpoints"
      via: "ProxmoxClient HTTP methods"
      pattern: "client\\.(get|post|put).*nodes.*qemu"
    - from: "apps/dashboard/prisma/schema.prisma"
      to: "Template model extensions"
      via: "templateType enum field"
      pattern: "templateType.*TemplateType"
---

<objective>
Extend the existing LXC template system to support VM templates with OpenClaw-specific configurations.

Purpose: Enable creation and management of VM templates alongside existing LXC templates, specifically targeting OpenClaw deployment with cloud-init automation.
Output: Database schema supporting both LXC and VM templates, plus Proxmox VM API integration for template management.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md
@apps/dashboard/src/lib/proxmox/containers.ts
@apps/dashboard/src/lib/proxmox/schemas.ts
@apps/dashboard/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema for VM template support</name>
  <files>apps/dashboard/prisma/schema.prisma</files>
  <action>
    Add VM template support to existing Template model:
    
    1. Add TemplateType enum with values: lxc, vm
    2. Add templateType field to Template model (defaulting to 'lxc' for backward compatibility)
    3. Add VM-specific fields to Template model:
       - biosType: String? (seabios, ovmf for UEFI) 
       - cpuType: String? (host, kvm64, etc.)
       - machine: String? (pc, q35)
       - cloudInitStorage: String? (storage for cloud-init ISO)
       - efidisk: String? (UEFI variables storage)
    4. Update existing indexes to include templateType for efficient VM/LXC filtering
    
    Preserve all existing LXC fields - Template model supports both LXC and VM configs.
    Run prisma db push after schema changes.
  </action>
  <verify>npx prisma db push succeeds, npx prisma generate succeeds, prisma studio shows new VM fields</verify>
  <done>Template model supports both templateType enum and VM-specific configuration fields</done>
</task>

<task type="auto">
  <name>Task 2: Create Proxmox VM API integration</name>
  <files>apps/dashboard/src/lib/proxmox/vms.ts</files>
  <action>
    Create VM management API using same patterns as containers.ts:
    
    1. Export functions: listVMs, createVM, deleteVM, getVMStatus, getVMConfig
    2. VM creation supports cloud-init with user-data/vendor-data
    3. Template creation: createVMTemplate() that clones existing VM to template
    4. Use Proxmox /nodes/{node}/qemu endpoints 
    5. Support VM-specific configs: UEFI boot, virtio storage, cloud-init drives
    6. Handle VMID auto-assignment similar to containers
    7. Use proper error handling and typing patterns from existing code
    
    Focus on cloud-init automation - vendor-data for OpenClaw installation, user-data for SSH keys.
    Reference research findings for Ubuntu 24.04 + Node.js 22 setup patterns.
  </action>
  <verify>TypeScript compilation succeeds, exports match expected function signatures</verify>
  <done>VM management functions available for template creation and cloud-init automation</done>
</task>

<task type="auto">
  <name>Task 3: Add VM configuration schemas and type definitions</name>
  <files>apps/dashboard/src/lib/proxmox/schemas.ts, apps/dashboard/src/lib/proxmox/types.ts, apps/dashboard/src/lib/proxmox/index.ts</files>
  <action>
    Extend Proxmox schemas and types for VM support:
    
    schemas.ts:
    - VMCreateConfigSchema with VM-specific fields (bios, cpu, machine, memory, storage)
    - CloudInitConfigSchema for user-data/vendor-data validation
    - VMTemplateSchema for template metadata
    
    types.ts:
    - VMCreateConfig interface matching schema
    - VMTemplate, VMStatus, VMConfig interfaces
    - CloudInitConfig interface with userData/vendorData fields
    
    index.ts:
    - Export new VM functions and types
    - Re-export VM schemas for use in server actions
    
    Follow existing patterns from container schemas. VM configs must validate required fields for OpenClaw: memory ≥ 2GB, cores ≥ 2, network interface.
  </action>
  <verify>TypeScript compilation succeeds, schemas validate expected VM configurations</verify>
  <done>VM configuration validation and type definitions available for template system integration</done>
</task>

</tasks>

<verification>
- Database migration completes successfully with new VM fields
- Proxmox VM API functions can create cloud-init enabled VMs  
- VM configuration schemas validate OpenClaw requirements
- TypeScript compilation passes for all modified files
</verification>

<success_criteria>

- Template model supports both LXC and VM template types
- VM creation API supports cloud-init automation patterns from research
- Configuration validation ensures OpenClaw minimum requirements (2GB RAM, 2 cores, Node.js-ready)
- Foundation ready for VM template UI and OpenClaw template creation
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md`
</output>
