---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/dashboard/middleware.ts
  - apps/dashboard/src/app/layout.tsx
  - apps/dashboard/src/components/app-sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "Unauthenticated users visiting any route get redirected to /login"
    - "Authenticated users can access all dashboard routes"
    - "Authenticated users visiting /login get redirected to /"
    - "Logout button in sidebar clears session and redirects to /login"
    - "Login page does NOT show the sidebar navigation"
    - "Session persists across page refreshes (cookie + Redis)"
  artifacts:
    - path: "apps/dashboard/middleware.ts"
      provides: "Route protection middleware"
      min_lines: 15
      contains: "NextResponse.redirect"
    - path: "apps/dashboard/src/app/layout.tsx"
      provides: "Conditional layout — sidebar for authenticated routes, minimal for /login"
      contains: "SidebarProvider"
    - path: "apps/dashboard/src/components/app-sidebar.tsx"
      provides: "Sidebar with logout button"
      contains: "logoutAction"
  key_links:
    - from: "apps/dashboard/middleware.ts"
      to: "iron-session cookie"
      via: "reads lxc-session cookie from request"
      pattern: "lxc-session|getIronSession|request.cookies"
    - from: "apps/dashboard/src/components/app-sidebar.tsx"
      to: "apps/dashboard/src/lib/auth/actions.ts"
      via: "form calls logoutAction"
      pattern: "logoutAction"
    - from: "apps/dashboard/src/app/layout.tsx"
      to: "apps/dashboard/src/components/app-sidebar.tsx"
      via: "conditionally renders sidebar based on route"
      pattern: "AppSidebar|SidebarProvider"
---

<objective>
Wire route protection middleware and integrate authentication into the app layout.

Purpose: Without middleware, users can bypass login and access dashboard routes directly. Without layout changes, the login page shows the sidebar (wrong), and there's no way to log out. This plan completes the auth flow end-to-end.

Output: Working middleware that protects all routes, conditional layout (sidebar hidden on /login), and a logout button in the sidebar.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@apps/dashboard/src/lib/session.ts
@apps/dashboard/src/lib/auth/actions.ts
@apps/dashboard/src/app/layout.tsx
@apps/dashboard/src/components/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js middleware for route protection</name>
  <files>
    apps/dashboard/middleware.ts
  </files>
  <action>
Create `apps/dashboard/middleware.ts` (at the app root, NOT inside src — Next.js requires this location):

1. Import `NextResponse` from `next/server` and `getIronSession` from `iron-session/edge` (or `iron-session` — check iron-session docs for Edge Runtime / middleware support).

2. IMPORTANT: Next.js middleware runs in Edge Runtime. iron-session supports middleware via `getIronSession(req, res, options)` pattern using `cookies()` from the request. For Next.js middleware specifically, use the `cookies()` API from the request/response objects.

3. The middleware function should:
   - Get the pathname from `request.nextUrl.pathname`
   - Define public paths: `["/login"]` and static assets `/_next/`, `/favicon.ico`
   - If path matches a public path or starts with `/_next/` → `NextResponse.next()` (allow through)
   - For protected paths: read the iron-session cookie from the request. Since middleware is Edge, you can read the cookie value directly from `request.cookies.get("lxc-session")`. If the cookie doesn't exist → redirect to `/login`
   - If cookie exists: We do a lightweight check — just verify the cookie is present. Full validation (Redis lookup, expiry check) happens server-side in the actual route. This keeps middleware fast and Edge-compatible (no Redis in Edge).
   - If user is authenticated (has cookie) and visits `/login` → redirect to `/`
   - Return `NextResponse.next()` for authenticated requests to protected routes

4. Export the `config` matcher to exclude static files:
   ```
   export const config = {
     matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
   };
   ```

NOTE: Do NOT attempt Redis calls in middleware — Edge Runtime doesn't support Node.js Redis clients. The cookie existence check is sufficient for middleware. Server-side routes validate the full session.
</action>
<verify> - File exists at `apps/dashboard/middleware.ts` (NOT src/middleware.ts) - `npx tsc --noEmit` passes - Middleware exports default function and config matcher - No Redis imports in middleware file (Edge-compatible)
</verify>
<done> - Middleware redirects unauthenticated users to /login - Middleware allows /login route without authentication - Middleware redirects authenticated users away from /login to / - Static assets (\_next/, favicon.ico) bypass middleware - Middleware is Edge Runtime compatible (no Node.js-only APIs)
</done>
</task>

<task type="auto">
  <name>Task 2: Conditional layout and sidebar logout button</name>
  <files>
    apps/dashboard/src/app/layout.tsx
    apps/dashboard/src/components/app-sidebar.tsx
    apps/dashboard/src/app/login/layout.tsx
  </files>
  <action>
1. Update `src/app/layout.tsx` (root layout):
   - The root layout currently wraps ALL pages in SidebarProvider + AppSidebar. This is wrong for the login page.
   - Solution: Make the root layout minimal — just html, body, fonts, metadata. Move the sidebar layout into a route group.
   - New root layout: `<html>` → `<body className={fonts}>` → `{children}` only
   - Create `src/app/(dashboard)/layout.tsx` as a new route group layout that contains the SidebarProvider, AppSidebar, SidebarInset, header with SidebarTrigger. This is the authenticated layout.
   - Move the existing `src/app/page.tsx` to `src/app/(dashboard)/page.tsx` so it inherits the dashboard layout.
   - The login page at `src/app/login/page.tsx` (already created in Plan 01) stays outside the route group, so it gets only the root layout (no sidebar).
   - If `src/app/login/layout.tsx` was created in Plan 01, remove it or keep it minimal (just returns children) — the route group approach handles the layout separation.

2. Update `src/components/app-sidebar.tsx`:
   - Add a SidebarFooter section after SidebarContent with a logout button
   - Import `LogOut` icon from lucide-react
   - Import `SidebarFooter` from the sidebar UI components
   - Create a small form in the footer: `<form action={logoutAction}>` with a button containing the LogOut icon and "Sign out" text
   - Import `logoutAction` from `@/lib/auth/actions`
   - Since this is a client component ("use client"), you'll need to handle the server action form pattern. Use a regular `<form action={logoutAction}>` — React 19 supports server actions in form action attributes even in client components.
   - Style the logout button to match the sidebar's design: use `SidebarMenuButton` component style, muted colors, hover state
   - Optionally display the logged-in username in the sidebar footer. To get the username, create a small server component wrapper or pass it as a prop. The simplest approach: make the sidebar accept an optional `username` prop, and in the dashboard layout, fetch the session and pass it down.

3. In `src/app/(dashboard)/layout.tsx`:
   - Import `getSessionData` from `@/lib/session`
   - Call `getSessionData()` to get the current session
   - Pass `username={session?.username}` to `<AppSidebar>`
   - This is a server component, so async data fetching is fine
     </action>
     <verify>
   - `npx tsc --noEmit` passes
   - Route group structure: `src/app/(dashboard)/layout.tsx` and `src/app/(dashboard)/page.tsx` exist
   - Root layout (`src/app/layout.tsx`) does NOT contain SidebarProvider
   - Login page at /login renders without sidebar
   - Dashboard at / renders with sidebar
   - Sidebar contains a "Sign out" button in the footer
     </verify>
     <done>
   - Login page renders WITHOUT sidebar (clean centered form)
   - All dashboard routes render WITH sidebar (existing navigation preserved)
   - Sidebar footer shows username and a "Sign out" button
   - Sign out button calls logoutAction, clears session, redirects to /login
   - Route group pattern cleanly separates authenticated vs unauthenticated layouts
     </done>
     </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow</name>
  <what-built>
Complete Proxmox SSO authentication flow:
- Login page with username/realm/password form
- Redis-backed session management via iron-session
- Route protection middleware
- Conditional layout (no sidebar on login page)
- Logout button in sidebar
  </what-built>
  <how-to-verify>
1. Start dev environment: `docker compose -f docker-compose.dev.yaml up -d` (for Redis + PostgreSQL)
2. Start dev server: `npm run dev` in apps/dashboard
3. Visit http://localhost:3001/ — should redirect to /login
4. Verify login page: clean form centered on screen, NO sidebar visible
5. Enter invalid credentials — should show error message
6. Enter valid Proxmox credentials (your PVE host) — should redirect to /
7. Dashboard shows with sidebar, username visible in sidebar footer
8. Refresh page — should remain authenticated (session persists)
9. Click "Sign out" in sidebar — should redirect to /login, session cleared
10. Try visiting http://localhost:3001/ again — should redirect to /login (session gone)

**Environment variables needed in .env:**

- `PROXMOX_HOST` — your Proxmox VE hostname/IP
- `PROXMOX_PORT` — usually 8006
- `SESSION_SECRET` — any 32+ character string for iron-session
- `REDIS_URL` — e.g., redis://localhost:6379
- `ENCRYPTION_KEY` — 64-char hex string (may already exist)
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works, or describe issues</resume-signal>
  </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Unauthenticated request to / returns redirect to /login
3. /login page renders without sidebar
4. Login form has username, realm, password fields
5. Successful login redirects to / with sidebar visible
6. Logout clears session and redirects to /login
7. Session persists across page refresh
</verification>

<success_criteria>

- Middleware protects all routes except /login
- Route group layout correctly separates sidebar from login
- Logout button in sidebar footer works end-to-end
- Complete auth flow: login → use dashboard → logout → back to login
- No TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
