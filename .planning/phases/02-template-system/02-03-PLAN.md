---
phase: 02-template-system
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/dashboard/src/lib/db.ts
  - apps/dashboard/src/lib/packages/actions.ts
  - apps/dashboard/src/app/templates/packages/page.tsx
  - apps/dashboard/src/app/templates/packages/loading.tsx
  - apps/dashboard/src/components/packages/bucket-card.tsx
  - apps/dashboard/src/components/packages/bucket-form-dialog.tsx
  - apps/dashboard/src/components/packages/package-list.tsx
autonomous: true

must_haves:
  truths:
    - "User can view all package buckets with their packages listed"
    - "User can create a new package bucket with a name and description"
    - "User can edit a bucket's name and description"
    - "User can delete an empty bucket (delete is blocked if bucket has packages linked to templates)"
    - "User can add individual packages to a bucket"
    - "User can remove packages from a bucket"
    - "User can bulk import packages by pasting .apt file content (one package per line)"
  artifacts:
    - path: "apps/dashboard/src/lib/db.ts"
      provides: "PackageBucket and Package CRUD methods on DatabaseService"
      contains: "listBuckets"
    - path: "apps/dashboard/src/lib/packages/actions.ts"
      provides: "Server actions for bucket and package CRUD"
      contains: "use server"
    - path: "apps/dashboard/src/app/templates/packages/page.tsx"
      provides: "Package bucket management page"
      min_lines: 30
    - path: "apps/dashboard/src/components/packages/bucket-form-dialog.tsx"
      provides: "Dialog for creating/editing buckets"
      contains: "use client"
  key_links:
    - from: "apps/dashboard/src/lib/packages/actions.ts"
      to: "apps/dashboard/src/lib/db.ts"
      via: "Server actions call DatabaseService bucket/package methods"
      pattern: "DatabaseService\\.(createBucket|updateBucket|deleteBucket|addPackage|removePackage)"
    - from: "apps/dashboard/src/app/templates/packages/page.tsx"
      to: "apps/dashboard/src/lib/db.ts"
      via: "RSC fetches buckets via DatabaseService"
      pattern: "DatabaseService\\.listBuckets"
    - from: "apps/dashboard/src/components/packages/bucket-form-dialog.tsx"
      to: "apps/dashboard/src/lib/packages/actions.ts"
      via: "Form submits via server actions"
      pattern: "createBucketAction|updateBucketAction"
---

<objective>
Implement full package bucket CRUD — DatabaseService methods, server actions, and management UI at /templates/packages. Users can create/edit/delete buckets, add/remove packages, and bulk import from .apt content.

Purpose: Package buckets are a core building block for templates. They group packages (like "base", "development") that can be assigned to templates. This needs to work before the template editor can reference buckets.

Output: /templates/packages page with bucket cards, create/edit dialogs, package management, and bulk import.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-system/02-01-SUMMARY.md

@apps/dashboard/src/lib/db.ts
@apps/dashboard/prisma/schema.prisma
@apps/dashboard/src/components/ui/card.tsx
@apps/dashboard/src/components/ui/input.tsx
@apps/dashboard/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: PackageBucket DatabaseService methods and server actions</name>
  <files>
    apps/dashboard/src/lib/db.ts
    apps/dashboard/src/lib/packages/actions.ts
  </files>
  <action>
1. **Extend DatabaseService in `src/lib/db.ts`** with PackageBucket and Package operations.

Import types: `PackageBucket, Package, PackageManager` from `@/generated/prisma/client`.

Add section comment: `// ============================================================================`
`// PackageBucket Operations`  
 `// ============================================================================`

Add these static methods:

a. **`listBuckets(): Promise<BucketWithPackages[]>`** - Fetch all buckets with their packages included: `include: { packages: true }` - Order by name ascending - Define and export `BucketWithPackages = PackageBucket & { packages: Package[] }`

b. **`getBucketById(id: string): Promise<BucketWithPackages | null>`** - Fetch single bucket with packages included

c. **`createBucket(data: { name: string; description?: string }): Promise<PackageBucket>`** - Create bucket with Prisma

d. **`updateBucket(id: string, data: { name?: string; description?: string }): Promise<PackageBucket>`** - Update bucket fields

e. **`deleteBucket(id: string): Promise<void>`** - Before deleting: check if any packages in this bucket are referenced by templates. Query: `prisma.package.count({ where: { bucketId: id, templateId: { not: null } } })`. Actually, looking at the schema again — packages have EITHER bucketId OR templateId, not both. So a bucket can always be deleted, and its packages cascade. BUT we should check if the bucket name corresponds to any template's discovered packages. The simpler approach per the issue: "Delete blocked if in use by template" — check if any template was discovered with packages from this bucket. Simplest: just allow delete (cascade handles cleanup) but show a warning in the UI if bucket has packages. The issue says "blocked if in use" so: count packages in bucket, if > 0 and bucket was created by discovery (heuristic: check if there are packages with this bucketId), throw an error or return a result indicating blocked.

      Simplest correct approach: Delete the bucket. Prisma cascade will delete packages. The "blocked if in use" constraint from #78 means: if a template references packages from this bucket. Since discovery creates packages in buckets (not directly on templates), we check if re-discovery would recreate them. Actually, let's just check: `prisma.package.count({ where: { bucketId: id } })` — if > 0, return an error "Bucket has packages. Remove all packages first." This is the safest UX.

      Implementation: Throw an error if bucket has packages. Let the action catch it.

f. **`addPackageToBucket(bucketId: string, data: { name: string; manager: PackageManager; version?: string }): Promise<Package>`** - Create a package in the bucket

g. **`removePackage(id: string): Promise<void>`** - Delete package by ID

h. **`bulkAddPackagesToBucket(bucketId: string, packages: { name: string; manager: PackageManager }[]): Promise<number>`** - Use `prisma.package.createMany({ data: packages.map(p => ({ ...p, bucketId })) })` - Return count of created packages - Skip duplicates: before creating, query existing package names in bucket, filter out duplicates

i. **`getBucketCount(): Promise<number>`** - Simple count

2. **Create `src/lib/packages/actions.ts`** with `"use server"` directive:

   Import DatabaseService and Zod for validation.

   a. **`createBucketAction(prevState: ActionState, formData: FormData): Promise<ActionState>`** - Validate with Zod: name (string, 1-50 chars, required), description (string, optional, max 200 chars) - Call DatabaseService.createBucket() - On success: `revalidatePath("/templates/packages")`, return `{ success: true }` - On error: return `{ success: false, error: message }` - Use React 19 useActionState compatible signature

   b. **`updateBucketAction(prevState: ActionState, formData: FormData): Promise<ActionState>`** - Extract id from formData (hidden field) - Validate same as create - Call DatabaseService.updateBucket() - revalidatePath, return result

   c. **`deleteBucketAction(id: string): Promise<ActionState>`** - NOT a form action — called directly via onClick - Call DatabaseService.deleteBucket() - If bucket has packages, catch error and return `{ success: false, error: "Remove all packages before deleting this bucket" }` - On success: revalidatePath, return `{ success: true }`

   d. **`addPackageAction(prevState: ActionState, formData: FormData): Promise<ActionState>`** - Extract bucketId, name, manager from formData - Validate: name non-empty, manager is valid PackageManager - Call DatabaseService.addPackageToBucket() - revalidatePath

   e. **`removePackageAction(id: string): Promise<ActionState>`** - Call DatabaseService.removePackage() - revalidatePath

   f. **`bulkImportAction(prevState: ActionState, formData: FormData): Promise<ActionState>`** - Extract bucketId and content (textarea text) from formData - Parse content: split by newlines, trim, filter out blanks and lines starting with "#" - Determine manager: extract from formData (default "apt") - Call DatabaseService.bulkAddPackagesToBucket() - revalidatePath, return `{ success: true, message: "Imported N packages" }`

   Define `ActionState = { success: boolean; error?: string; message?: string }` and export it.
   </action>
   <verify> - `npx tsc --noEmit` passes - DatabaseService has: listBuckets, getBucketById, createBucket, updateBucket, deleteBucket, addPackageToBucket, removePackage, bulkAddPackagesToBucket - actions.ts has "use server" directive and exports all 6 actions - Zod validation on create/update bucket actions
   </verify>
   <done> - DatabaseService extended with full PackageBucket and Package CRUD - Server actions handle create, update, delete buckets with validation - Server actions handle add, remove, bulk import packages - Delete bucket blocked when packages exist - All actions revalidate /templates/packages path
   </done>
   </task>

<task type="auto">
  <name>Task 2: Package bucket management UI</name>
  <files>
    apps/dashboard/src/app/templates/packages/page.tsx
    apps/dashboard/src/app/templates/packages/loading.tsx
    apps/dashboard/src/components/packages/bucket-card.tsx
    apps/dashboard/src/components/packages/bucket-form-dialog.tsx
    apps/dashboard/src/components/packages/package-list.tsx
  </files>
  <action>
First, install the shadcn Dialog component (needed for create/edit modals):
```bash
cd apps/dashboard && npx shadcn@latest add dialog textarea badge label --yes
```
This adds Dialog, Textarea, Badge, and Label components needed for this UI.

Also add the `sonner` toast library for feedback:

```bash
cd apps/dashboard && npx shadcn@latest add sonner --yes
```

Add `<Toaster />` to the root layout (`src/app/layout.tsx`) inside the body tag.

1. **Create `src/components/packages/bucket-card.tsx`** ("use client"):
   - Props: `{ bucket: BucketWithPackages }`
   - Renders a shadcn Card with:
     - CardHeader: bucket name as CardTitle, description as CardDescription
     - Package count badge in header: e.g., "12 packages"
     - CardContent: `<PackageList>` component showing packages
     - CardFooter: Edit button (opens dialog), Delete button (with confirmation)
   - Delete button: calls `deleteBucketAction(bucket.id)` directly. Show toast on success/error. Use `useTransition` for pending state.
   - Edit button: triggers the BucketFormDialog in edit mode

2. **Create `src/components/packages/bucket-form-dialog.tsx`** ("use client"):
   - Dual-purpose dialog for create AND edit
   - Props: `{ mode: "create" | "edit"; bucket?: BucketWithPackages; trigger: React.ReactNode }`
   - Uses shadcn Dialog with DialogTrigger (the trigger prop), DialogContent, DialogHeader, DialogTitle
   - Form fields:
     - Name: shadcn Input, required
     - Description: shadcn Textarea, optional
   - Hidden field for id when in edit mode
   - Submit using `useActionState` with `createBucketAction` or `updateBucketAction` based on mode
   - On success: close dialog (manage open state), show success toast
   - On error: show error inline

3. **Create `src/components/packages/package-list.tsx`** ("use client"):
   - Props: `{ bucketId: string; packages: Package[]; manager?: PackageManager }`
   - Shows packages as a list/grid of badges or small items
   - Each package: name displayed, small "x" button to remove (calls `removePackageAction`)
   - "Add package" inline form at bottom: Input for name, select for manager type (apt/npm/pip), Add button. Uses `addPackageAction`.
   - "Bulk Import" button: opens a section/dialog with a Textarea for pasting .apt/.npm content, a manager select, and an Import button. Uses `bulkImportAction`.
   - Keep the UI compact — packages are small items, not cards

4. **Create `src/app/templates/packages/page.tsx`** (Server Component):
   - Fetch all buckets: `DatabaseService.listBuckets()`
   - Page header: "Package Buckets" title, "Manage reusable groups of packages for your templates" description
   - "Create Bucket" button in header — wraps `<BucketFormDialog mode="create" trigger={<Button>Create Bucket</Button>} />`
   - Grid of BucketCards: `<div className="grid gap-4 md:grid-cols-2">` (2 columns — buckets are wider than template cards due to package lists)
   - Empty state: "No package buckets yet. Create one or run template discovery to auto-discover packages."

5. **Create `src/app/templates/packages/loading.tsx`**:
   - Skeleton UI matching the bucket card grid layout
   - 4 skeleton cards

6. **Update sidebar navigation** in `src/components/app-sidebar.tsx`:
   - Add a "Packages" sub-item under Templates, or add it as a separate nav item with the Package icon from lucide-react
   - Actually, keep it simple: add it as a nav item: `{ title: "Packages", href: "/templates/packages", icon: Package2 }` (use Package2 from lucide-react since Package conflicts with the Prisma type name). Insert it after the Templates entry.
     </action>
     <verify>
   - `npx tsc --noEmit` passes
   - New shadcn components installed: Dialog, Textarea, Badge, Label, Sonner
   - /templates/packages page renders with empty state or bucket cards
   - Create bucket dialog opens, form submits, bucket appears
   - Edit bucket dialog pre-populates and saves changes
   - Delete bucket works (when no packages) and shows error (when has packages)
   - Add package form adds package to bucket
   - Remove package button removes it
   - Bulk import textarea parses and adds packages
   - Sidebar has Packages link
     </verify>
     <done>
   - /templates/packages shows all package buckets in a card grid
   - Create/edit bucket works via dialog with form validation
   - Delete bucket works with protection against non-empty buckets
   - Individual package add/remove within buckets works
   - Bulk import from .apt content (paste-based) works
   - Toast notifications provide feedback for all actions
   - Sidebar navigation updated with Packages link
     </done>
     </task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all types correct
2. /templates/packages page accessible and renders
3. Full bucket lifecycle: create → add packages → edit → remove packages → delete
4. Bulk import correctly parses multi-line package content
5. Delete protection prevents accidental data loss
6. Toast feedback on all mutations
7. Sidebar navigation includes Packages link
</verification>

<success_criteria>

- Package bucket CRUD fully operational through server actions
- UI provides clear feedback for all operations (toasts, loading states)
- Bulk import handles comments and blank lines correctly
- Delete protection works (cannot delete bucket with packages)
- Navigation updated to include package management
  </success_criteria>

<output>
After completion, create `.planning/phases/02-template-system/02-03-SUMMARY.md`
</output>
