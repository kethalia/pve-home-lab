---
phase: 02-template-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/dashboard/src/lib/db.ts
  - apps/dashboard/src/app/templates/page.tsx
  - apps/dashboard/src/app/templates/loading.tsx
  - apps/dashboard/src/components/templates/template-card.tsx
  - apps/dashboard/src/components/templates/template-search.tsx
  - apps/dashboard/src/components/templates/discover-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can visit /templates and see a grid of template cards"
    - "Each card shows template name, description, tags, and resource summary (CPU, RAM, disk)"
    - "User can search templates by name"
    - "User can filter templates by tag"
    - "A 'Discover Templates' button triggers filesystem discovery and refreshes the list"
    - "Empty state shows a message prompting discovery when no templates exist"
  artifacts:
    - path: "apps/dashboard/src/lib/db.ts"
      provides: "Template query methods on DatabaseService (listTemplates, getTemplateById, etc.)"
      contains: "listTemplates"
    - path: "apps/dashboard/src/app/templates/page.tsx"
      provides: "Server Component template browser page with search/filter"
      min_lines: 40
    - path: "apps/dashboard/src/components/templates/template-card.tsx"
      provides: "Card component for template grid display"
      contains: "TemplateCard"
    - path: "apps/dashboard/src/components/templates/template-search.tsx"
      provides: "Client component for search input and tag filter"
      contains: "use client"
  key_links:
    - from: "apps/dashboard/src/app/templates/page.tsx"
      to: "apps/dashboard/src/lib/db.ts"
      via: "RSC data fetching with DatabaseService.listTemplates()"
      pattern: "DatabaseService\\.listTemplates"
    - from: "apps/dashboard/src/app/templates/page.tsx"
      to: "apps/dashboard/src/components/templates/template-card.tsx"
      via: "Renders TemplateCard for each template"
      pattern: "TemplateCard"
    - from: "apps/dashboard/src/components/templates/template-search.tsx"
      to: "apps/dashboard/src/app/templates/page.tsx"
      via: "URL search params for search/filter (server-side filtering)"
      pattern: "searchParams|useRouter|router\\.push"
---

<objective>
Add Template query methods to DatabaseService and build the template browser page at /templates with card grid, search, tag filtering, and a discovery trigger button.

Purpose: Users need to see what templates are available. This is the primary entry point for the template system — a browsable, searchable grid of discovered templates.

Output: /templates page showing template cards with search and tag filtering, plus DatabaseService methods for template queries.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-system/02-01-SUMMARY.md

@apps/dashboard/src/lib/db.ts
@apps/dashboard/src/app/layout.tsx
@apps/dashboard/src/app/page.tsx
@apps/dashboard/prisma/schema.prisma
@apps/dashboard/src/components/ui/card.tsx
@apps/dashboard/src/components/ui/input.tsx
@apps/dashboard/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template DatabaseService methods</name>
  <files>
    apps/dashboard/src/lib/db.ts
  </files>
  <action>
Add Template query methods to the existing DatabaseService class in `src/lib/db.ts`. Follow the same pattern as the existing ProxmoxNode operations.

Import the Template type: `import type { ProxmoxNode, Template } from "@/generated/prisma/client"`.

Add a new section comment: `// ============================================================================`
`// Template Operations`
`// ============================================================================`

Add these static methods:

1. **`listTemplates(options?: { search?: string; tags?: string[]; orderBy?: "name" | "updatedAt" }): Promise<Template[]>`**
   - Build a Prisma `where` clause dynamically:
     - If `search` provided: `name: { contains: search, mode: "insensitive" }`
     - If `tags` provided (array of tag strings): Filter templates whose `tags` field contains ALL specified tags. Since tags are stored as semicolon-separated strings, use `AND` with multiple `tags: { contains: tag }` conditions.
   - Default orderBy: `name` ascending
   - Include counts in the return: use `include: { _count: { select: { scripts: true, files: true, packages: true } } }`
   - Return type should actually be the template with counts. Define a type:
     ```ts
     type TemplateWithCounts = Template & {
       _count: { scripts: number; files: number; packages: number };
     };
     ```
     Export this type.

2. **`getTemplateById(id: string): Promise<TemplateWithDetails | null>`**
   - Fetch template with ALL related data:
     ```ts
     include: {
       scripts: { orderBy: { order: "asc" } },
       files: true,
       packages: true,
     }
     ```
   - Define and export `TemplateWithDetails` type using Prisma's generated types

3. **`getTemplateTags(): Promise<string[]>`**
   - Fetch all unique tags across all templates
   - Query all templates, extract tags fields, split by ";", deduplicate, sort alphabetically
   - Return unique tag array

4. **`getTemplateCount(): Promise<number>`**
   - Simple count: `prisma.template.count()`

5. **`deleteTemplate(id: string): Promise<void>`**
   - Delete template by ID (cascading deletes handle scripts/files/packages per schema)
   - `prisma.template.delete({ where: { id } })`

Keep the existing ProxmoxNode operations untouched. Add new operations below them.
</action>
<verify> - `npx tsc --noEmit` passes in apps/dashboard - DatabaseService has methods: listTemplates, getTemplateById, getTemplateTags, getTemplateCount, deleteTemplate - Types exported: TemplateWithCounts, TemplateWithDetails
</verify>
<done> - DatabaseService extended with full Template query/delete operations - listTemplates supports search by name and tag filtering - getTemplateById returns template with all related scripts, files, packages - getTemplateTags returns deduplicated sorted tag list - All methods follow existing static method pattern
</done>
</task>

<task type="auto">
  <name>Task 2: Template browser page and components</name>
  <files>
    apps/dashboard/src/app/templates/page.tsx
    apps/dashboard/src/app/templates/loading.tsx
    apps/dashboard/src/components/templates/template-card.tsx
    apps/dashboard/src/components/templates/template-search.tsx
    apps/dashboard/src/components/templates/discover-button.tsx
  </files>
  <action>
1. **Create `src/components/templates/template-card.tsx`** (Server Component — no "use client"):
   - Props: `{ template: TemplateWithCounts }` (import type from db.ts)
   - Renders a shadcn Card with Link wrapping to `/templates/${template.id}`
   - Card content:
     - **Name** as CardTitle
     - **Description** truncated to 2 lines (`line-clamp-2`)
     - **Tags** as small badges below description. Style tags as: `<span className="inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary">`. Split template.tags by ";" and render each.
     - **Resource summary** at bottom: CPU cores, RAM (format MB as GB if >= 1024), Disk GB. Use a flex row with small icons or text labels: `${cores} cores · ${memory}MB RAM · ${diskSize}GB`
     - **Stats row**: script count, file count, package count from _count. E.g., "11 scripts · 4 files · 23 packages"
   - Card hover state: `hover:border-primary/50 transition-colors cursor-pointer`
   - Source badge: small "filesystem" or "custom" indicator in top-right using `template.source`

2. **Create `src/components/templates/template-search.tsx`** (Client Component — "use client"):
   - A search/filter bar component
   - Props: `{ tags: string[]; currentSearch?: string; currentTags?: string[] }`
   - Search input: uses shadcn Input with a search icon (import Search from lucide-react). Debounced — on change, update URL search params after 300ms delay using `useRouter().replace()` with updated `searchParams`. URL param: `?search=query`.
   - Tag filter: horizontal scrollable row of tag buttons (toggle on/off). Active tags highlighted with `bg-primary text-primary-foreground`, inactive with `bg-muted`. Clicking a tag adds/removes it from `?tags=tag1,tag2` URL param.
   - Use `useSearchParams()` from `next/navigation` to read current state
   - Use `useRouter()` and `usePathname()` to update URL without full page reload
   - Wrap component in `<Suspense>` when using `useSearchParams` (Next.js requirement)

3. **Create `src/app/templates/page.tsx`** (Server Component — RSC):
   - Accept `searchParams` prop (Next.js page props): `{ searchParams: Promise<{ search?: string; tags?: string }> }`
   - Await searchParams (Next.js 15 async searchParams)
   - Parse: `search` string, `tags` split by "," into array
   - Fetch data using DatabaseService:
     - `DatabaseService.listTemplates({ search, tags })`
     - `DatabaseService.getTemplateTags()` (for filter options)
   - Render:
     - Page header: `<h1>Templates</h1>` with description text
     - Action buttons row (right-aligned):
       - "Discover Templates" button — this needs to be a client component. Create a small inline `DiscoverButton` client component in the same file or a separate file that calls `discoverTemplatesAction` from Plan 01's actions.ts, shows loading spinner during discovery, then calls `router.refresh()` to reload the page data.
       - Link to "/templates/new" with "Create Template" text (for Plan 05, just add the link now)
     - `<TemplateSearch>` component with tags and current params
     - **Empty state**: If no templates found and no search active, show a centered message: "No templates discovered yet. Click 'Discover Templates' to scan your filesystem." with an icon.
     - **No results state**: If no templates found BUT search is active, show: "No templates match your search."
     - **Template grid**: `<div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">` mapping templates to `<TemplateCard>` components

4. **Create `src/app/templates/loading.tsx`**:
   - Uses Skeleton components from shadcn/ui
   - Shows 6 skeleton cards in the same grid layout as the real page
   - Each skeleton card mimics the card structure: skeleton title, skeleton description lines, skeleton badges

For the DiscoverButton: Create it as a separate client component `src/components/templates/discover-button.tsx` to keep separation clean.

- "use client"
- Import `discoverTemplatesAction` from `@/lib/templates/actions`
- On click: set loading state, call action, show toast or result count, call `router.refresh()`
- Use `useTransition` for the async operation to avoid blocking UI
- Show spinner (lucide-react Loader2 with animate-spin) when pending
  </action>
  <verify> - `npx tsc --noEmit` passes in apps/dashboard - Files exist: templates/page.tsx, templates/loading.tsx, template-card.tsx, template-search.tsx - Dev server: visiting http://localhost:3001/templates shows the page (empty state initially) - After running discovery, cards appear in grid - Search input filters templates by name - Tag buttons filter by tag
  </verify>
  <done> - /templates page renders with header, action buttons, search bar, and template grid - Template cards show name, description, tags, resources, and counts - Search filters templates by name (URL param based, server-side filtering) - Tag filter toggles filter by tags (URL param based) - Discover button triggers filesystem discovery and refreshes page - Empty state guides user to run discovery - Loading skeleton provides visual feedback during navigation
  </done>
  </task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all types correct
2. /templates page accessible and renders
3. DatabaseService.listTemplates() returns templates with _count
4. Search updates URL and filters server-side
5. Tag filter works with multiple tags
6. Discover button triggers action and refreshes grid
7. Empty state renders when no templates exist
8. Loading skeletons display during page transitions
</verification>

<success_criteria>

- /templates shows a responsive card grid of discovered templates
- Search by name works with debounced input
- Tag filtering works (toggle on/off, multiple tags)
- Discover Templates button scans filesystem and refreshes
- Empty state is helpful, not just blank
- Cards link to /templates/[id] (detail page built in Plan 04)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-template-system/02-02-SUMMARY.md`
</output>
