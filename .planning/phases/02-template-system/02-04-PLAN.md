---
phase: 02-template-system
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - apps/dashboard/src/app/templates/[id]/page.tsx
  - apps/dashboard/src/app/templates/[id]/loading.tsx
  - apps/dashboard/src/components/templates/template-config-tab.tsx
  - apps/dashboard/src/components/templates/template-scripts-tab.tsx
  - apps/dashboard/src/components/templates/template-packages-tab.tsx
  - apps/dashboard/src/components/templates/template-files-tab.tsx
  - apps/dashboard/src/lib/templates/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can visit /templates/[id] and see the template's full details"
    - "Config tab shows resource settings (CPU, RAM, disk) and feature flags (nesting, keyctl, fuse)"
    - "Scripts tab shows all scripts in execution order with content viewable"
    - "Packages tab shows packages grouped by bucket/manager"
    - "Files tab shows config files with target path, policy, and content viewable"
    - "User can navigate between tabs without page reload"
    - "An Edit button links to /templates/[id]/edit"
  artifacts:
    - path: "apps/dashboard/src/app/templates/[id]/page.tsx"
      provides: "Template detail page with tabbed layout"
      min_lines: 40
    - path: "apps/dashboard/src/components/templates/template-scripts-tab.tsx"
      provides: "Scripts display with ordering and expandable content"
      contains: "TemplateScriptsTab"
    - path: "apps/dashboard/src/components/templates/template-packages-tab.tsx"
      provides: "Packages grouped by bucket with badge display"
      contains: "TemplatePackagesTab"
    - path: "apps/dashboard/src/components/templates/template-files-tab.tsx"
      provides: "Config files display with path, policy, and content"
      contains: "TemplateFilesTab"
  key_links:
    - from: "apps/dashboard/src/app/templates/[id]/page.tsx"
      to: "apps/dashboard/src/lib/db.ts"
      via: "RSC fetches template via DatabaseService.getTemplateById()"
      pattern: "DatabaseService\\.getTemplateById"
    - from: "apps/dashboard/src/app/templates/[id]/page.tsx"
      to: "apps/dashboard/src/components/templates/template-scripts-tab.tsx"
      via: "Renders tab components with template data"
      pattern: "TemplateScriptsTab"
---

<objective>
Build the template detail page at /templates/[id] with a tabbed interface showing Config, Scripts, Packages, and Files — all read-only for now.

Purpose: Users need to inspect template details before using them to create containers. The detail page is the core information view for any template, showing everything discovered or configured.

Output: /templates/[id] page with four tabs showing all template data in an organized, readable format.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-system/02-02-SUMMARY.md

@apps/dashboard/src/lib/db.ts
@apps/dashboard/prisma/schema.prisma
@apps/dashboard/src/components/ui/card.tsx
@apps/dashboard/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Tabs component and create tab content components</name>
  <files>
    apps/dashboard/src/components/templates/template-config-tab.tsx
    apps/dashboard/src/components/templates/template-scripts-tab.tsx
    apps/dashboard/src/components/templates/template-packages-tab.tsx
    apps/dashboard/src/components/templates/template-files-tab.tsx
  </files>
  <action>
Install the shadcn Tabs and Collapsible components:
```bash
cd apps/dashboard && npx shadcn@latest add tabs collapsible --yes
```

1. **Create `src/components/templates/template-config-tab.tsx`** (Server Component):
   - Props: `{ template: TemplateWithDetails }` (import type from db.ts)
   - Display template configuration in organized sections using Cards:

     **General section:**
     - Name, Description, Source (filesystem/custom), Path
     - OS Template string (e.g., "debian-12-standard")
     - Tags displayed as badges

     **Resources section** (use a 2x2 or 3-col grid of stat items):
     - CPU: cores count
     - Memory: MB value (also show as GB if >= 1024)
     - Swap: MB value
     - Disk: GB value
     - Storage target (e.g., "local-lvm")
     - Network bridge (e.g., "vmbr0")

     **Features section** (grid of on/off indicators):
     - Unprivileged: boolean → green "Enabled" / gray "Disabled"
     - Nesting: boolean → same
     - Keyctl: boolean → same
     - FUSE: boolean → same

   - Each section in its own Card with CardHeader/CardContent
   - Use a clean label-value layout: `<dt className="text-sm text-muted-foreground">Label</dt><dd className="font-medium">Value</dd>` in a dl grid

2. **Create `src/components/templates/template-scripts-tab.tsx`** (Client Component — "use client" for expandable sections):
   - Props: `{ scripts: TemplateScript[] }` (from Prisma types)
   - Display scripts in execution order (they come pre-sorted from getTemplateById)
   - Each script as a collapsible item:
     - Header row: order number badge (e.g., "00"), script name, enabled/disabled badge
     - Expandable content: script content in a `<pre><code>` block with monospace font, light gray background, horizontal scroll for long lines
     - Use shadcn Collapsible component or a simple state toggle
   - If description exists, show it below the name in muted text
   - Show total count in tab: "11 scripts"
   - Empty state: "No scripts configured"

3. **Create `src/components/templates/template-packages-tab.tsx`** (Server Component):
   - Props: `{ packages: Package[] }` (from Prisma types)
   - Group packages by manager type (apt, npm, pip)
   - Within each group, display as a list or badge grid
   - Each package: name, version (if set)
   - Group headers: "APT Packages (12)", "NPM Packages (3)", etc.
   - Use Badge component for each package: `<Badge variant="secondary">{name}</Badge>`
   - If version specified: `<Badge>{name}@{version}</Badge>`
   - Empty state: "No packages configured"

4. **Create `src/components/templates/template-files-tab.tsx`** (Client Component — "use client" for expandable content):
   - Props: `{ files: TemplateFile[] }` (from Prisma types)
   - Each file as a card or collapsible:
     - Header: file name, target path (as monospace text), policy badge (color-coded: replace=red, default=blue, backup=yellow)
     - Expandable content: file content in `<pre><code>` block (same style as scripts)
   - Show total count: "4 files"
   - Empty state: "No config files"
     </action>
     <verify>
   - `npx tsc --noEmit` passes
   - Tabs and Collapsible shadcn components installed
   - All 4 tab components created with correct props
   - Components use proper Prisma types
     </verify>
     <done>
   - Config tab displays resources, features, and general info in organized cards
   - Scripts tab shows ordered, expandable scripts with syntax-highlighted content
   - Packages tab groups packages by manager type with badge display
   - Files tab shows files with target path, policy badge, and expandable content
     </done>
     </task>

<task type="auto">
  <name>Task 2: Template detail page with tabs layout</name>
  <files>
    apps/dashboard/src/app/templates/[id]/page.tsx
    apps/dashboard/src/app/templates/[id]/loading.tsx
  </files>
  <action>
1. **Create `src/app/templates/[id]/page.tsx`** (Server Component):
   - Accept `params` prop: `{ params: Promise<{ id: string }> }` (Next.js 15 async params)
   - Await params to get the id
   - Fetch template: `DatabaseService.getTemplateById(id)`
   - If not found: call `notFound()` from `next/navigation` (renders 404)
   - Page layout:
     
     **Header section:**
     - Back link: `← Back to Templates` linking to `/templates` (use Link from next/link)
     - Template name as h1
     - Description below in muted text
     - Source badge (filesystem/custom) and tags as badges
     - Action buttons (right-aligned in header):
       - "Edit Template" link to `/templates/${id}/edit` (for Plan 05)
       - Consider a "Delete Template" button with confirmation — calls a server action. Actually, delete is already in DatabaseService from Plan 02. Create a small delete action here or import from a shared actions file.
     
     **Tabs section:**
     - Use shadcn Tabs component with `defaultValue="config"`
     - TabsList with 4 triggers: Config, Scripts (with count), Packages (with count), Files (with count)
     - TabsContent for each tab renders the corresponding component:
       - Config: `<TemplateConfigTab template={template} />`
       - Scripts: `<TemplateScriptsTab scripts={template.scripts} />`
       - Packages: `<TemplatePackagesTab packages={template.packages} />`
       - Files: `<TemplateFilesTab files={template.files} />`
     - Tab counts in triggers: "Scripts (11)", "Packages (23)", "Files (4)"
   
   - Set page metadata: `export function generateMetadata()` returning template name as title

2. **Create `src/app/templates/[id]/loading.tsx`**:
   - Skeleton layout matching the detail page structure
   - Skeleton for header (back link, title, description, badges)
   - Skeleton tabs with skeleton content area
   - Use existing Skeleton component from shadcn

3. **Create a delete action** — add to `src/lib/templates/actions.ts` (from Plan 01):
   **`deleteTemplateAction(id: string): Promise<ActionState>`**
   - Call `DatabaseService.deleteTemplate(id)`
   - On success: `revalidatePath("/templates")`, `redirect("/templates")`
   - On error: return error state
     This extends the actions file from Plan 01 with template management actions.
     </action>
     <verify> - `npx tsc --noEmit` passes - /templates/[id] page renders with template data - All 4 tabs are clickable and display correct content - Tab switching is client-side (no page reload) - Back link returns to /templates - Edit button links to /templates/[id]/edit - 404 page shows for invalid template IDs - Loading skeleton displays during navigation
     </verify>
     <done> - /templates/[id] shows full template detail with tabbed interface - Config tab shows resource settings and feature flags - Scripts tab shows all scripts in order with expandable content - Packages tab shows packages grouped by manager type - Files tab shows config files with path, policy, and content - Navigation: back to templates list, edit button, delete capability - Page metadata reflects template name
     </done>
     </task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all types correct
2. /templates/[id] renders for a valid template ID
3. All 4 tabs display correct data (config, scripts, packages, files)
4. Tab switching is instant (client-side)
5. Script and file content is expandable/collapsible
6. 404 for invalid ID
7. Edit link and delete action functional
8. Loading skeleton displays properly
</verification>

<success_criteria>

- Template detail page fully shows all template data across 4 organized tabs
- Scripts displayed in execution order with full content viewable
- Packages grouped logically by manager type
- Files show target path and policy with content viewable
- Navigation between tabs is smooth (no page reload)
- Back navigation and edit link work correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/02-template-system/02-04-SUMMARY.md`
</output>
