---
phase: 04-container-management
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/dashboard/src/app/(dashboard)/page.tsx
  - apps/dashboard/src/app/(dashboard)/containers/page.tsx
  - apps/dashboard/src/components/containers/summary-bar.tsx
  - apps/dashboard/src/components/containers/container-card.tsx
  - apps/dashboard/src/components/containers/container-grid.tsx
  - apps/dashboard/src/components/containers/status-badge.tsx
  - apps/dashboard/src/components/containers/container-actions.tsx
  - apps/dashboard/src/lib/containers/data.ts
autonomous: true

must_haves:
  truths:
    - "User can see the total, running, stopped, and error container counts on the dashboard"
    - "User can see container cards in a responsive grid showing hostname, VMID, status, IP, and quick actions"
    - "Container status reflects the live Proxmox status (running/stopped), not just the DB lifecycle"
    - "User can filter containers by status (all, running, stopped, error)"
    - "User can trigger start/stop/restart/delete from quick action buttons on each card"
    - "Dashboard auto-refreshes every 30 seconds"
    - "Empty state shows a link to the container creation wizard"
  artifacts:
    - path: "apps/dashboard/src/app/(dashboard)/page.tsx"
      provides: "Dashboard page with server-side data fetching and Proxmox status sync"
      contains: "SummaryBar"
    - path: "apps/dashboard/src/components/containers/container-card.tsx"
      provides: "Container card component with status badge, info, and action buttons"
      contains: "ContainerCard"
    - path: "apps/dashboard/src/lib/containers/data.ts"
      provides: "getContainersWithStatus and getContainerDetailData functions that merge DB + Proxmox status"
      contains: "getContainersWithStatus"
  key_links:
    - from: "apps/dashboard/src/app/(dashboard)/page.tsx"
      to: "apps/dashboard/src/lib/containers/data.ts"
      via: "Server component calls getContainersWithStatus for merged data"
      pattern: "getContainersWithStatus"
    - from: "apps/dashboard/src/components/containers/container-actions.tsx"
      to: "apps/dashboard/src/lib/containers/actions.ts"
      via: "Quick actions call lifecycle server actions"
      pattern: "startContainerAction|stopContainerAction|deleteContainerAction"
    - from: "apps/dashboard/src/app/(dashboard)/page.tsx"
      to: "apps/dashboard/src/lib/db.ts"
      via: "Fetches container counts via DatabaseService"
      pattern: "getContainerCounts"
---

<objective>
Build the container dashboard page — the main landing page showing a summary bar with counts, a responsive grid of container cards with live Proxmox status, filter controls, quick lifecycle actions, auto-refresh, and an empty state linking to the creation wizard.

Purpose: This is the primary interface users see. It gives an at-a-glance view of all containers and their health, with quick controls for common lifecycle actions.

Output: Replaced placeholder dashboard with full container management overview.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-container-management/04-01-SUMMARY.md

@apps/dashboard/src/app/(dashboard)/page.tsx
@apps/dashboard/src/app/(dashboard)/layout.tsx
@apps/dashboard/src/lib/db.ts
@apps/dashboard/src/lib/containers/helpers.ts
@apps/dashboard/src/lib/containers/actions.ts
@apps/dashboard/src/lib/proxmox/containers.ts
@apps/dashboard/src/lib/proxmox/schemas.ts
@apps/dashboard/src/components/ui/card.tsx
@apps/dashboard/src/components/ui/button.tsx
@apps/dashboard/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Container data fetching with Proxmox status sync</name>
  <files>
    apps/dashboard/src/lib/containers/data.ts
  </files>
  <action>
Create `src/lib/containers/data.ts` with `import "server-only"`. This provides data fetching functions that merge DB records with live Proxmox status.

**Types:**

```ts
export type ContainerStatus =
  | "running"
  | "stopped"
  | "creating"
  | "error"
  | "unknown";

export interface ContainerWithStatus {
  id: string;
  vmid: number;
  hostname: string | null; // From Proxmox, may be null
  status: ContainerStatus;
  lifecycle: "creating" | "ready" | "error";
  ip: string | null;
  uptime: number | null; // seconds
  memory: { used: number; max: number } | null;
  cpu: number | null; // 0-1 fraction
  disk: { used: number; max: number } | null;
  template: { id: string; name: string } | null;
  node: { id: string; name: string };
  serviceCount: number;
  servicesHealthy: number; // count of services with status "running"
  createdAt: Date;
}

export interface DashboardData {
  containers: ContainerWithStatus[];
  counts: {
    total: number;
    running: number;
    stopped: number;
    creating: number;
    error: number;
  };
}
```

**Main function:**

```ts
export async function getContainersWithStatus(): Promise<DashboardData>;
```

Implementation:

1. Call `createProxmoxClientFromSession()` from helpers to get client + node
2. Call `DatabaseService.listContainersWithRelations()` to get all DB containers
3. Call `listContainers(client, node.name)` from Proxmox to get live status for ALL containers on the node (single API call, efficient)
4. Merge: For each DB container:
   - Find matching Proxmox container by VMID
   - If found and lifecycle is "ready": use Proxmox status (running/stopped)
   - If lifecycle is "creating": status = "creating"
   - If lifecycle is "error": status = "error"
   - If not found in Proxmox: status = "unknown" (container may have been deleted externally)
   - Extract hostname, IP (from Proxmox name field), memory, CPU, disk from Proxmox data
   - Count services and healthy services from DB relations
5. Calculate counts from merged data
6. Return `{ containers, counts }`

For IP extraction: Proxmox's listContainers response doesn't include IP directly. The container's `name` field is the hostname. For IP, we'd need to query each container's config (expensive for many containers). **Compromise:** Don't show IP on dashboard cards (show it on detail page only where we query config for a single container). Show hostname (from Proxmox `name` field) instead.

Handle Proxmox API failures gracefully: if the API call fails (e.g., expired session), still return DB data with status "unknown" for all containers. Log the error but don't crash the page.

**Also add `getContainerDetailData` in the same file** (used by Plan 04-04's detail page):

Types:

```ts
export type ContainerStatus =
  | "running"
  | "stopped"
  | "creating"
  | "error"
  | "unknown";

export interface ContainerDetailData {
  id: string;
  vmid: number;
  hostname: string | null;
  status: ContainerStatus;
  lifecycle: "creating" | "ready" | "error";
  createdAt: Date;
  updatedAt: Date;
  config: {
    cores: number | null;
    memory: number | null;
    swap: number | null;
    disk: string | null;
    hostname: string | null;
    nameserver: string | null;
    searchdomain: string | null;
    net0: string | null;
    features: string | null;
    unprivileged: boolean | null;
    ostype: string | null;
    arch: string | null;
    description: string | null;
    tags: string | null;
    onboot: boolean | null;
  };
  resources: {
    cpuUsage: number | null;
    memUsed: number | null;
    memMax: number | null;
    swapUsed: number | null;
    swapMax: number | null;
    diskUsed: number | null;
    diskMax: number | null;
    uptime: number | null;
    netIn: number | null;
    netOut: number | null;
  };
  template: { id: string; name: string; description: string | null } | null;
  node: { id: string; name: string; host: string };
  services: Array<{
    id: string;
    name: string;
    type: string;
    port: number | null;
    webUrl: string | null;
    status: string;
    credentials: string | null;
  }>;
  events: Array<{
    id: string;
    type: string;
    message: string;
    metadata: string | null;
    createdAt: Date;
  }>;
}
```

Function:

```ts
export async function getContainerDetailData(
  containerId: string,
): Promise<ContainerDetailData | null>;
```

Implementation:

1. Call `DatabaseService.getContainerWithDetails(containerId)` — return null if not found
2. Call `createProxmoxClientFromSession()` to get client + node
3. Call `getContainer(client, node.name, container.vmid)` for live status + resources
4. Call `getContainerConfig(client, node.name, container.vmid)` for full config
5. Merge: DB data + Proxmox status + Proxmox config → ContainerDetailData
6. If Proxmox API calls fail, still return data with null resources and config from DB only

Handle the case where container doesn't exist in Proxmox (deleted externally): return data with status "unknown" and null resources.

  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists at `apps/dashboard/src/lib/containers/data.ts`
    - Exports `getContainersWithStatus`, `ContainerWithStatus`, `DashboardData`, `getContainerDetailData`, `ContainerDetailData`
    - Both functions handle Proxmox API failure gracefully (returns "unknown" status)
    - Functions merge DB lifecycle with live Proxmox status correctly
  </verify>
  <done>
    - getContainersWithStatus merges DB + Proxmox data in a single efficient call for dashboard
    - getContainerDetailData merges DB + Proxmox config + Proxmox status for detail page
    - ContainerWithStatus type provides all data needed for container cards
    - ContainerDetailData type provides all data needed for detail page tabs
    - Proxmox API failure doesn't crash the page
    - Status correctly derived: creating containers show "creating", ready containers show Proxmox live status
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard UI components and page</name>
  <files>
    apps/dashboard/src/app/(dashboard)/page.tsx
    apps/dashboard/src/components/containers/summary-bar.tsx
    apps/dashboard/src/components/containers/container-card.tsx
    apps/dashboard/src/components/containers/container-grid.tsx
    apps/dashboard/src/components/containers/status-badge.tsx
    apps/dashboard/src/components/containers/container-actions.tsx
  </files>
  <action>
**1. Create `src/components/containers/status-badge.tsx`** (client component)

A small badge component showing container status with appropriate colors:

- `running` → green (bg-green-100 text-green-700)
- `stopped` → gray (bg-gray-100 text-gray-700)
- `creating` → blue (bg-blue-100 text-blue-700) with pulse animation
- `error` → red (bg-red-100 text-red-700)
- `unknown` → yellow (bg-yellow-100 text-yellow-700)

Use shadcn Badge if available, otherwise a simple `<span>` with rounded-full, px-2, py-0.5, text-xs, font-medium classes. Export `StatusBadge` taking `{ status: ContainerStatus }`.

**2. Create `src/components/containers/container-actions.tsx`** (client component — `"use client"`)

Quick action dropdown/buttons for a container. Uses `useTransition` for optimistic UI.

Props: `{ containerId: string; status: ContainerStatus; containerName: string | null }`

- If running: Show Stop, Restart, and Delete buttons
- If stopped: Show Start and Delete buttons
- If creating/error/unknown: Show only Delete button (for error/unknown cleanup)

Each button:

- Uses `useTransition` to track pending state
- Calls the corresponding server action (startContainerAction, stopContainerAction, etc.)
- Shows loading spinner while pending
- Uses `confirm()` dialog for destructive actions (stop, delete)

Layout: Use a dropdown menu (shadcn DropdownMenu if available) or inline icon buttons. For simplicity, use inline icon buttons with Lucide icons:

- Play icon for Start
- Square icon for Stop
- RotateCcw icon for Restart
- Trash2 icon for Delete

Install lucide-react if not already available: `pnpm add lucide-react` (check package.json first).

**3. Create `src/components/containers/container-card.tsx`** (client component for actions)

A Card showing container info:

- **Header:** Hostname (bold) + VMID (muted, small) + StatusBadge
- **Body:** Template name (if any), Node name, service health (e.g., "3/4 services healthy"), created date (relative time like "2 hours ago")
- **Footer:** ContainerActions component
- **Click:** Entire card (except action buttons) links to `/containers/{id}` using Next.js Link

Use shadcn Card with CardHeader, CardContent, CardFooter.

Props: `ContainerWithStatus` (from data.ts types).

For relative time: use a simple helper function `timeAgo(date: Date): string` — no external dependency. Handle: "just now", "X minutes ago", "X hours ago", "X days ago".

**4. Create `src/components/containers/summary-bar.tsx`** (server component)

A row of 4 stat cards:

- Total containers (count)
- Running (count, green accent)
- Stopped (count, gray accent)
- Error (count, red accent — only show if > 0)

Use shadcn Card, small size. Responsive: 4 cols on lg, 2 cols on md, 1 col on mobile.

Props: `{ counts: DashboardData["counts"] }`

**5. Create `src/components/containers/container-grid.tsx`** (client component — `"use client"`)

Container grid with filter controls and auto-refresh.

Props: `{ containers: ContainerWithStatus[] }`

Features:

- **Filter bar:** Buttons for "All", "Running", "Stopped", "Error" — uses `useState` for active filter
- **Sort:** By name (default), by status, by date — use `useState` for sort
- **Grid:** Responsive grid of ContainerCards (3 cols on lg, 2 on md, 1 on mobile)
- **Empty state:** If no containers at all, show a Card with message "No containers yet" and a Button linking to `/containers/new` ("Create your first container")
- **Filtered empty state:** If filter yields no results, show "No {status} containers"
- **Auto-refresh:** Use `useRouter().refresh()` every 30 seconds via `useEffect` + `setInterval`. This triggers server component re-render, which re-fetches data. Clean up interval on unmount.

**6. Replace `src/app/(dashboard)/page.tsx`** (server component)

Replace the placeholder dashboard with:

```tsx
import { getContainersWithStatus } from "@/lib/containers/data";
import { SummaryBar } from "@/components/containers/summary-bar";
import { ContainerGrid } from "@/components/containers/container-grid";

export default async function DashboardPage() {
  const { containers, counts } = await getContainersWithStatus();

  return (
    <div className="flex flex-1 flex-col gap-6">
      <div>
        <h1 className="text-3xl font-bold">Dashboard</h1>
        <p className="text-muted-foreground">
          Monitor and manage your LXC containers
        </p>
      </div>

      <SummaryBar counts={counts} />
      <ContainerGrid containers={containers} />
    </div>
  );
}
```

Also create `src/app/(dashboard)/containers/page.tsx` that redirects to `/` or shows the same dashboard (both routes should work). Simplest: make it import and re-export the same page, or use `redirect("/")` from `next/navigation`.

  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Dashboard page at `src/app/(dashboard)/page.tsx` imports and renders SummaryBar + ContainerGrid
    - SummaryBar shows 4 count cards
    - ContainerCard shows hostname, VMID, status badge, template, services count
    - ContainerActions shows appropriate buttons based on status, uses useTransition
    - ContainerGrid has filter buttons and 30s auto-refresh
    - Empty state shows link to /containers/new
    - All components use shadcn/ui Card and Tailwind classes
  </verify>
  <done>
    - Dashboard page replaced with full container overview
    - Summary bar shows total/running/stopped/error counts
    - Container cards show key info with status badges and quick action buttons
    - Filter by status (All/Running/Stopped/Error)
    - Auto-refresh every 30 seconds via useRouter().refresh()
    - Empty state guides user to create first container
    - Lifecycle actions wired via useTransition for optimistic UI
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all files type-check
2. Dashboard page renders SummaryBar and ContainerGrid
3. Status correctly synced from Proxmox API (running containers show green)
4. Quick actions call lifecycle server actions from 04-01
5. Auto-refresh works (30s interval)
6. Filter buttons work for All/Running/Stopped/Error
7. Empty state renders with link to wizard
8. Proxmox API failure shows containers with "unknown" status (doesn't crash)
</verification>

<success_criteria>

- Dashboard shows real container data from DB + Proxmox
- Status badges reflect live Proxmox status
- Quick actions (start/stop/restart/delete) work from dashboard
- Auto-refresh keeps dashboard current
- Empty state guides new users to create containers
- Responsive layout works on desktop and mobile
  </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-03-SUMMARY.md`
</output>
