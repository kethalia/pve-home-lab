#!/bin/bash
# Custom installer for browser-based development tools
# - code-server: VS Code in the browser
# - filebrowser: Web-based file manager
# - opencode: Alternative code editor with webui

set -euo pipefail

INSTALL_LOG="/var/log/web-tools-install.log"
exec > >(tee -a "$INSTALL_LOG") 2>&1

echo "=== Installing browser-based development tools ==="

# Install code-server (VS Code in browser)
install_code_server() {
    echo "Installing code-server..."
    
    # Install code-server
    curl -fsSL https://code-server.dev/install.sh | sh -s -- --version 4.20.0
    
    # Create systemd service for coder user
    cat > /etc/systemd/system/code-server@.service <<'EOF'
[Unit]
Description=code-server
After=network.target

[Service]
Type=exec
ExecStart=/usr/bin/code-server --bind-addr 0.0.0.0:8080 --auth password
Restart=always
User=%i
Environment=PASSWORD=coder

[Install]
WantedBy=default.target
EOF

    systemctl daemon-reload
    systemctl enable code-server@coder
    systemctl start code-server@coder
    
    echo "✓ code-server installed and running on port 8080 (password: coder)"
}

# Install filebrowser
install_filebrowser() {
    echo "Installing filebrowser..."
    
    # Download and install filebrowser
    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash
    
    # Create filebrowser config
    mkdir -p /etc/filebrowser
    cat > /etc/filebrowser/config.json <<'EOF'
{
  "port": 8081,
  "baseURL": "",
  "address": "0.0.0.0",
  "log": "stdout",
  "database": "/etc/filebrowser/filebrowser.db",
  "root": "/home/coder"
}
EOF

    # Create systemd service
    cat > /etc/systemd/system/filebrowser.service <<'EOF'
[Unit]
Description=File Browser
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/filebrowser -c /etc/filebrowser/config.json
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

    # Initialize database and set admin user
    filebrowser -d /etc/filebrowser/filebrowser.db config init
    filebrowser -d /etc/filebrowser/filebrowser.db users add admin coder --perm.admin
    
    systemctl daemon-reload
    systemctl enable filebrowser
    systemctl start filebrowser
    
    echo "✓ filebrowser installed and running on port 8081 (admin/coder)"
}

# Install opencode
install_opencode() {
    echo "Installing opencode..."
    
    # Install opencode via npm
    npm install -g @opencoder/opencode
    
    # Create systemd service for opencode
    cat > /etc/systemd/system/opencode@.service <<'EOF'
[Unit]
Description=OpenCode Web Editor
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/opencode --host 0.0.0.0 --port 8082
Restart=always
User=%i
WorkingDirectory=/home/%i

[Install]
WantedBy=default.target
EOF

    systemctl daemon-reload
    systemctl enable opencode@coder
    systemctl start opencode@coder
    
    echo "✓ opencode installed and running on port 8082"
}

# Install VS Code extensions for code-server (matching Coder template)
install_vscode_extensions() {
    echo "Installing VS Code extensions for code-server..."
    
    # Wait for code-server to be fully started
    sleep 5
    
    # Install all extensions from Coder template as coder user
    sudo -u coder /usr/bin/code-server --install-extension binary-ink.dark-modern-oled-theme-set
    sudo -u coder /usr/bin/code-server --install-extension pkief.material-icon-theme
    sudo -u coder /usr/bin/code-server --install-extension prisma.prisma
    sudo -u coder /usr/bin/code-server --install-extension graphql.vscode-graphql
    sudo -u coder /usr/bin/code-server --install-extension graphql.vscode-graphql-syntax
    sudo -u coder /usr/bin/code-server --install-extension bradlc.vscode-tailwindcss
    sudo -u coder /usr/bin/code-server --install-extension tintinweb.vscode-solidity-language
    sudo -u coder /usr/bin/code-server --install-extension nomicfoundation.hardhat-solidity
    sudo -u coder /usr/bin/code-server --install-extension esbenp.prettier-vscode
    sudo -u coder /usr/bin/code-server --install-extension eamodio.gitlens
    sudo -u coder /usr/bin/code-server --install-extension oderwat.indent-rainbow
    sudo -u coder /usr/bin/code-server --install-extension gruntfuggly.todo-tree
    sudo -u coder /usr/bin/code-server --install-extension pflannery.vscode-versionlens
    sudo -u coder /usr/bin/code-server --install-extension ms-vsliveshare.vsliveshare
    sudo -u coder /usr/bin/code-server --install-extension hashicorp.terraform
    sudo -u coder /usr/bin/code-server --install-extension ms-azuretools.vscode-docker
    sudo -u coder /usr/bin/code-server --install-extension cweijan.vscode-postgresql-client2
    sudo -u coder /usr/bin/code-server --install-extension usernamehw.errorlens
    sudo -u coder /usr/bin/code-server --install-extension streetsidesoftware.code-spell-checker
    sudo -u coder /usr/bin/code-server --install-extension wayou.vscode-todo-highlight
    
    echo "✓ VS Code extensions installed (20 extensions from Coder template)"
}

# Configure VS Code settings (matching Coder template exactly)
configure_vscode_settings() {
    echo "Configuring VS Code settings..."
    
    mkdir -p /home/coder/.local/share/code-server/User
    cat > /home/coder/.local/share/code-server/User/settings.json <<'EOF'
{
    "[solidity]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode",
        "editor.formatOnSave": true
    },
    "solidity.telemetry": false,
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.fontFamily": "Fira Code",
    "editor.fontLigatures": true,
    "editor.formatOnSave": true,
    "editor.wordWrap": "on",
    "editor.inlineSuggest.enabled": true,
    "editor.bracketPairColorization.enabled": true,
    "editor.guides.bracketPairs": true,
    "editor.minimap.enabled": false,
    "editor.stickyScroll.enabled": true,
    "editor.tabSize": 2,
    "files.autoSave": "off",
    "files.watcherExclude": {
        "**/.git/objects/**": true,
        "**/.git/subtree-cache/**": true,
        "**/node_modules/**": true,
        "**/.hg/store/**": true,
        "**/dist/**": true,
        "**/build/**": true,
        "**/.next/**": true,
        "**/out/**": true
    },
    "git.confirmSync": false,
    "git.autofetch": true,
    "git.enableSmartCommit": true,
    "terminal.integrated.scrollback": 10000,
    "terminal.integrated.defaultProfile.linux": "bash",
    "terminal.integrated.fontSize": 14,
    "workbench.colorTheme": "Dark Modern (OLED Black) [Orange]",
    "workbench.iconTheme": "material-icon-theme",
    "explorer.confirmDelete": false,
    "explorer.confirmDragAndDrop": false,
    "docker.showStartPage": false
}
EOF

    chown -R coder:coder /home/coder/.local/share/code-server
    
    echo "✓ VS Code settings configured (matching Coder template)"
}

# Main installation
main() {
    install_code_server
    install_filebrowser
    # install_opencode  # Commented out - opencode package may not exist
    install_vscode_extensions
    configure_vscode_settings
    
    echo ""
    echo "=== Web Tools Installation Complete ==="
    echo ""
    echo "Access URLs (replace <container-ip> with your container's IP):"
    echo "  - VS Code:      http://<container-ip>:8080  (password: coder)"
    echo "  - FileBrowser:  http://<container-ip>:8081  (admin/coder)"
    echo "  - OpenCode:     http://<container-ip>:8082"
    echo ""
    echo "All services are running and will start automatically on boot."
}

main
