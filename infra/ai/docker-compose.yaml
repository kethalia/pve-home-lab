services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.30
    restart: unless-stopped
    depends_on:
      - ollama
      - kokoro-web
    ports:
      - ${OPEN_WEBUI_PORT:-8080}:8080
    volumes:
      - ${OPEN_WEBUI_DATA_DIR-/data/open-webui}:/app/backend/data
    environment:
      - WEBUI_SECRET_KEY
      - OLLAMA_BASE_URL
      - AUDIO_TTS_OPENAI_API_BASE_URL
      - AUDIO_TTS_OPENAI_API_KEY
      - AUDIO_TTS_ENGINE
      - AUDIO_TTS_MODEL
      - AUDIO_TTS_VOICE

  ollama:
    image: ollama/ollama:0.11.11
    restart: unless-stopped
    ports:
      - ${OLLAMA_PORT:-11434}:11434
    volumes:
      - ${OLLAMA_DATA_DIR-/data/ollama}:/root/.ollama
    environment:
      - OLLAMA_FLASH_ATTENTION
      - OLLAMA_KV_CACHE_TYPE
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu

  kokoro-web:
    image: ghcr.io/eduardolat/kokoro-web:latest
    restart: unless-stopped
    ports:
      - ${KOKORO_PORT:-3000}:3000
    volumes:
      - ${KOKORO_DATA_DIR-/dataq}:/kokoro/cache
    environment:
      - KW_SECRET_API_KEY
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu

  comfy-ui:
    build: ./comfy-ui
    restart: unless-stopped
    ports:
      - ${COMFY_UI_PORT:-8188}:8188
    volumes:
      - ${COMFY_UI_DATA_DIR-/data/comfy-ui}/models:/ComfyUI/models
      - ${COMFY_UI_DATA_DIR-/data/comfy-ui}/input:/ComfyUI/input
      - ${COMFY_UI_DATA_DIR-/data/comfy-ui}/output:/ComfyUI/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
